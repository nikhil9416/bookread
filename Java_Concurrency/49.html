<!DOCTYPE html>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=Edge" />
<meta charset="utf-8" />
</head>

<body style="margin: 0;">

<div id="p49" style="overflow: hidden; position: relative; background-color: white; width: 662px; height: 1017px;">

<!-- Begin shared CSS values -->
<style class="shared-css" type="text/css" >
.t {
	transform-origin: bottom left;
	z-index: 2;
	position: absolute;
	white-space: pre;
	overflow: visible;
	line-height: 1.5;
}
.text-container {
	white-space: pre;
}
@supports (-webkit-touch-callout: none) {
	.text-container {
		white-space: normal;
	}
}
</style>
<!-- End shared CSS values -->


<!-- Begin inline CSS -->
<style type="text/css" >

#t1_49{left:57px;bottom:942px;letter-spacing:0.2px;}
#t2_49{left:447px;bottom:942px;letter-spacing:0.13px;}
#t3_49{left:500px;bottom:942px;}
#t4_49{left:508px;bottom:942px;letter-spacing:0.07px;word-spacing:3.01px;}
#t5_49{left:80px;bottom:893px;letter-spacing:0.08px;word-spacing:0.66px;}
#t6_49{left:57px;bottom:875px;letter-spacing:0.12px;}
#t7_49{left:99px;bottom:875px;letter-spacing:0.1px;}
#t8_49{left:151px;bottom:875px;letter-spacing:0.07px;word-spacing:0.92px;}
#t9_49{left:288px;bottom:875px;letter-spacing:0.11px;word-spacing:0.6px;}
#ta_49{left:426px;bottom:875px;letter-spacing:0.08px;word-spacing:1.3px;}
#tb_49{left:57px;bottom:857px;letter-spacing:0.13px;word-spacing:0.46px;}
#tc_49{left:234px;bottom:857px;}
#td_49{left:241px;bottom:857px;}
#te_49{left:245px;bottom:857px;}
#tf_49{left:253px;bottom:857px;letter-spacing:0.11px;}
#tg_49{left:72px;bottom:809px;letter-spacing:-0.24px;word-spacing:0.75px;}
#th_49{left:72px;bottom:788px;letter-spacing:-0.29px;}
#ti_49{left:129px;bottom:788px;letter-spacing:-0.2px;}
#tj_49{left:154px;bottom:788px;letter-spacing:-0.25px;word-spacing:1.92px;}
#tk_49{left:552px;bottom:788px;letter-spacing:-0.29px;}
#tl_49{left:72px;bottom:767px;letter-spacing:-0.22px;word-spacing:0.04px;}
#tm_49{left:424px;bottom:767px;letter-spacing:-0.28px;word-spacing:0.94px;}
#tn_49{left:511px;bottom:767px;letter-spacing:-0.2px;word-spacing:-0.18px;}
#to_49{left:80px;bottom:719px;letter-spacing:0.1px;}
#tp_49{left:99px;bottom:720px;letter-spacing:0.1px;}
#tq_49{left:279px;bottom:719px;letter-spacing:0.08px;word-spacing:1.3px;}
#tr_49{left:349px;bottom:719px;}
#ts_49{left:357px;bottom:719px;}
#tt_49{left:361px;bottom:719px;}
#tu_49{left:368px;bottom:719px;}
#tv_49{left:377px;bottom:720px;letter-spacing:0.05px;}
#tw_49{left:462px;bottom:719px;letter-spacing:0.14px;}
#tx_49{left:493px;bottom:720px;letter-spacing:0.05px;}
#ty_49{left:586px;bottom:719px;letter-spacing:0.16px;}
#tz_49{left:57px;bottom:700px;letter-spacing:0.07px;word-spacing:1.23px;}
#t10_49{left:551px;bottom:701px;letter-spacing:0.05px;}
#t11_49{left:57px;bottom:683px;letter-spacing:0.05px;}
#t12_49{left:93px;bottom:682px;letter-spacing:0.08px;}
#t13_49{left:80px;bottom:664px;letter-spacing:0.08px;word-spacing:3.09px;}
#t14_49{left:57px;bottom:646px;letter-spacing:0.07px;word-spacing:2.03px;}
#t15_49{left:57px;bottom:627px;letter-spacing:0.06px;word-spacing:1.4px;}
#t16_49{left:57px;bottom:609px;letter-spacing:0.1px;word-spacing:0.75px;}
#t17_49{left:299px;bottom:609px;letter-spacing:0.1px;}
#t18_49{left:324px;bottom:609px;letter-spacing:0.08px;word-spacing:0.67px;}
#t19_49{left:57px;bottom:591px;letter-spacing:0.07px;word-spacing:0.25px;}
#t1a_49{left:57px;bottom:573px;letter-spacing:0.08px;word-spacing:1.08px;}
#t1b_49{left:57px;bottom:554px;letter-spacing:0.06px;word-spacing:1.27px;}
#t1c_49{left:476px;bottom:561px;}
#t1d_49{left:490px;bottom:554px;letter-spacing:-0.01px;word-spacing:1.44px;}
#t1e_49{left:57px;bottom:536px;letter-spacing:0.1px;}
#t1f_49{left:123px;bottom:536px;letter-spacing:0.08px;word-spacing:-0.01px;}
#t1g_49{left:230px;bottom:536px;letter-spacing:0.04px;}
#t1h_49{left:248px;bottom:536px;letter-spacing:0.09px;word-spacing:-0.36px;}
#t1i_49{left:400px;bottom:536px;letter-spacing:0.07px;word-spacing:0.15px;}
#t1j_49{left:57px;bottom:518px;letter-spacing:0.03px;word-spacing:0.88px;}
#t1k_49{left:72px;bottom:468px;letter-spacing:-0.26px;word-spacing:1.74px;}
#t1l_49{left:72px;bottom:448px;letter-spacing:-0.22px;word-spacing:-0.12px;}
#t1m_49{left:80px;bottom:402px;letter-spacing:0.08px;word-spacing:2.1px;}
#t1n_49{left:57px;bottom:384px;letter-spacing:0.08px;word-spacing:1.91px;}
#t1o_49{left:57px;bottom:365px;letter-spacing:0.09px;word-spacing:1.62px;}
#t1p_49{left:57px;bottom:347px;letter-spacing:0.09px;word-spacing:2.22px;}
#t1q_49{left:318px;bottom:348px;letter-spacing:0.05px;}
#t1r_49{left:372px;bottom:347px;letter-spacing:0.09px;word-spacing:2.25px;}
#t1s_49{left:57px;bottom:329px;letter-spacing:0.09px;}
#t1t_49{left:117px;bottom:329px;letter-spacing:0.08px;word-spacing:2.45px;}
#t1u_49{left:57px;bottom:311px;letter-spacing:0.05px;word-spacing:2.03px;}
#t1v_49{left:57px;bottom:292px;letter-spacing:0.09px;word-spacing:0.99px;}
#t1w_49{left:57px;bottom:274px;letter-spacing:0.06px;}
#t1x_49{left:82px;bottom:281px;letter-spacing:-0.13px;}
#t1y_49{left:100px;bottom:274px;letter-spacing:0.06px;word-spacing:0.37px;}
#t1z_49{left:57px;bottom:256px;letter-spacing:0.08px;word-spacing:0.71px;}
#t20_49{left:80px;bottom:238px;letter-spacing:0.09px;word-spacing:2.43px;}
#t21_49{left:57px;bottom:219px;letter-spacing:0.1px;word-spacing:0.68px;}
#t22_49{left:355px;bottom:219px;}
#t23_49{left:362px;bottom:219px;letter-spacing:0.06px;word-spacing:0.49px;}
#t24_49{left:57px;bottom:201px;letter-spacing:0.06px;word-spacing:2.1px;}
#t25_49{left:269px;bottom:202px;letter-spacing:0.05px;}
#t26_49{left:347px;bottom:201px;letter-spacing:0.12px;word-spacing:1.81px;}
#t27_49{left:57px;bottom:183px;letter-spacing:0.07px;word-spacing:1.63px;}
#t28_49{left:57px;bottom:165px;letter-spacing:0.1px;word-spacing:0.48px;}
#t29_49{left:57px;bottom:146px;letter-spacing:0.1px;word-spacing:0.31px;}
#t2a_49{left:57px;bottom:128px;letter-spacing:0.08px;word-spacing:0.67px;}
#t2b_49{left:57px;bottom:98px;}
#t2c_49{left:63px;bottom:98px;}
#t2d_49{left:74px;bottom:98px;letter-spacing:0.06px;word-spacing:1.95px;}
#t2e_49{left:57px;bottom:84px;letter-spacing:0.07px;word-spacing:0.53px;}
#t2f_49{left:57px;bottom:69px;letter-spacing:0.05px;}
#t2g_49{left:69px;bottom:69px;}
#t2h_49{left:80px;bottom:69px;letter-spacing:0.06px;word-spacing:2.52px;}
#t2i_49{left:57px;bottom:55px;letter-spacing:0.05px;word-spacing:0.62px;}

.s0_49{font-size:15px;font-family:TeXPalladioL-SC_amc;color:#000;}
.s1_49{font-size:15px;font-family:Palatino-Italic_amd;color:#000;}
.s2_49{font-size:15px;font-family:TeXPalladioL-ItalicOsF_amn;color:#000;}
.s3_49{font-size:15px;font-family:Palatino-Roman_ame;color:#000;}
.s4_49{font-size:15px;font-family:LucidaSans_amq;color:#000;}
.s5_49{font-size:15px;font-family:LucidaSans-Italic_ams;color:#000;}
.s6_49{font-size:13px;font-family:LucidaSansTypewriter_amm;color:#000;}
.s7_49{font-size:12px;font-family:TeXPalladioL-SC_amc;color:#000;}
.s8_49{font-size:12px;font-family:Palatino-Roman_ame;color:#000;}
</style>
<!-- End inline CSS -->

<!-- Begin embedded font definitions -->
<style id="fonts49" type="text/css" >

@font-face {
	font-family: LucidaSans-Italic_ams;
	src: url("fonts/LucidaSans-Italic_ams.woff") format("woff");
}

@font-face {
	font-family: LucidaSansTypewriter_amm;
	src: url("fonts/LucidaSansTypewriter_amm.woff") format("woff");
}

@font-face {
	font-family: LucidaSans_amq;
	src: url("fonts/LucidaSans_amq.woff") format("woff");
}

@font-face {
	font-family: Palatino-Italic_amd;
	src: url("fonts/Palatino-Italic_amd.woff") format("woff");
}

@font-face {
	font-family: Palatino-Roman_ame;
	src: url("fonts/Palatino-Roman_ame.woff") format("woff");
}

@font-face {
	font-family: TeXPalladioL-ItalicOsF_amn;
	src: url("fonts/TeXPalladioL-ItalicOsF_amn.woff") format("woff");
}

@font-face {
	font-family: TeXPalladioL-SC_amc;
	src: url("fonts/TeXPalladioL-SC_amc.woff") format("woff");
}

</style>
<!-- End embedded font definitions -->

<!-- Begin page background -->
<div id="pg49Overlay" style="width:100%; height:100%; position:absolute; z-index:1; background-color:rgba(0,0,0,0); -webkit-user-select: none;"></div>
<div id="pg49" style="-webkit-user-select: none;"><object width="662" height="1017" data="49/49.svg" type="image/svg+xml" id="pdf49" style="width:662px; height:1017px; -moz-transform:scale(1); z-index: 0;"></object></div>
<!-- End page background -->


<!-- Begin text definitions (Positioned/styled in CSS) -->
<div class="text-container"><span id="t1_49" class="t s0_49">28 </span><span id="t2_49" class="t s1_49">Chapter </span><span id="t3_49" class="t s2_49">2</span><span id="t4_49" class="t s1_49">. Thread Safety </span>
<span id="t5_49" class="t s3_49">It is a common mistake to assume that synchronization needs to be used only </span>
<span id="t6_49" class="t s3_49">when </span><span id="t7_49" class="t s1_49">writing </span><span id="t8_49" class="t s3_49">to shared variables; </span><span id="t9_49" class="t s1_49">this is simply not true</span><span id="ta_49" class="t s3_49">. (The reasons for this will </span>
<span id="tb_49" class="t s3_49">become clearer in Section </span><span id="tc_49" class="t s0_49">3</span><span id="td_49" class="t s3_49">.</span><span id="te_49" class="t s0_49">1</span><span id="tf_49" class="t s3_49">.) </span>
<span id="tg_49" class="t s4_49">For each mutable state variable that may be accessed by more than one </span>
<span id="th_49" class="t s4_49">thread, </span><span id="ti_49" class="t s5_49">all </span><span id="tj_49" class="t s4_49">accesses to that variable must be performed with the </span><span id="tk_49" class="t s5_49">same </span>
<span id="tl_49" class="t s4_49">lock held. In this case, we say that the variable is </span><span id="tm_49" class="t s5_49">guarded by </span><span id="tn_49" class="t s4_49">that lock. </span>
<span id="to_49" class="t s3_49">In </span><span id="tp_49" class="t s6_49">SynchronizedFactorizer </span><span id="tq_49" class="t s3_49">in Listing </span><span id="tr_49" class="t s0_49">2</span><span id="ts_49" class="t s3_49">.</span><span id="tt_49" class="t s0_49">6</span><span id="tu_49" class="t s3_49">, </span><span id="tv_49" class="t s6_49">lastNumber </span><span id="tw_49" class="t s3_49">and </span><span id="tx_49" class="t s6_49">lastFactors </span><span id="ty_49" class="t s3_49">are </span>
<span id="tz_49" class="t s3_49">guarded by the servlet object’s intrinsic lock; this is documented by the </span><span id="t10_49" class="t s6_49">@Guard- </span>
<span id="t11_49" class="t s6_49">edBy </span><span id="t12_49" class="t s3_49">annotation. </span>
<span id="t13_49" class="t s3_49">There is no inherent relationship between an object’s intrinsic lock and its </span>
<span id="t14_49" class="t s3_49" data-mappings='[[19,"fi"]]'>state; an object’s ﬁelds need not be guarded by its intrinsic lock, though this is </span>
<span id="t15_49" class="t s3_49">a perfectly valid locking convention that is used by many classes. Acquiring the </span>
<span id="t16_49" class="t s3_49">lock associated with an object does </span><span id="t17_49" class="t s1_49">not </span><span id="t18_49" class="t s3_49">prevent other threads from accessing that </span>
<span id="t19_49" class="t s3_49">object—the only thing that acquiring a lock prevents any other thread from doing </span>
<span id="t1a_49" class="t s3_49">is acquiring that same lock. The fact that every object has a built-in lock is just a </span>
<span id="t1b_49" class="t s3_49">convenience so that you needn’t explicitly create lock objects. </span>
<span id="t1c_49" class="t s7_49">9 </span>
<span id="t1d_49" class="t s3_49">It is up to you to </span>
<span id="t1e_49" class="t s3_49">construct </span><span id="t1f_49" class="t s1_49">locking protocols </span><span id="t1g_49" class="t s3_49">or </span><span id="t1h_49" class="t s1_49">synchronization policies </span><span id="t1i_49" class="t s3_49">that let you access shared state </span>
<span id="t1j_49" class="t s3_49">safely, and to use them consistently throughout your program. </span>
<span id="t1k_49" class="t s4_49">Every shared, mutable variable should be guarded by exactly one lock. </span>
<span id="t1l_49" class="t s4_49">Make it clear to maintainers which lock that is. </span>
<span id="t1m_49" class="t s3_49">A common locking convention is to encapsulate all mutable state within an </span>
<span id="t1n_49" class="t s3_49">object and to protect it from concurrent access by synchronizing any code path </span>
<span id="t1o_49" class="t s3_49">that accesses mutable state using the object’s intrinsic lock. This pattern is used </span>
<span id="t1p_49" class="t s3_49">by many thread-safe classes, such as </span><span id="t1q_49" class="t s6_49">Vector </span><span id="t1r_49" class="t s3_49">and other synchronized collection </span>
<span id="t1s_49" class="t s3_49">classes. </span><span id="t1t_49" class="t s3_49">In such cases, all the variables in an object’s state are guarded by the </span>
<span id="t1u_49" class="t s3_49">object’s intrinsic lock. However, there is nothing special about this pattern, and </span>
<span id="t1v_49" class="t s3_49">neither the compiler nor the runtime enforces this (or any other) pattern of lock- </span>
<span id="t1w_49" class="t s3_49">ing. </span>
<span id="t1x_49" class="t s7_49">10 </span>
<span id="t1y_49" class="t s3_49">It is also easy to subvert this locking protocol accidentally by adding a new </span>
<span id="t1z_49" class="t s3_49">method or code path and forgetting to use synchronization. </span>
<span id="t20_49" class="t s3_49">Not all data needs to be guarded by locks—only mutable data that will be </span>
<span id="t21_49" class="t s3_49">accessed from multiple threads. In Chapter </span><span id="t22_49" class="t s0_49">1</span><span id="t23_49" class="t s3_49">, we described how adding a simple </span>
<span id="t24_49" class="t s3_49">asynchronous event such as a </span><span id="t25_49" class="t s6_49">TimerTask </span><span id="t26_49" class="t s3_49">can create thread safety requirements </span>
<span id="t27_49" class="t s3_49">that ripple throughout your program, especially if your program state is poorly </span>
<span id="t28_49" class="t s3_49">encapsulated. Consider a single-threaded program that processes a large amount </span>
<span id="t29_49" class="t s3_49">of data. Single-threaded programs require no synchronization, because no data is </span>
<span id="t2a_49" class="t s3_49">shared across threads. Now imagine you want to add a feature to create periodic </span>
<span id="t2b_49" class="t s7_49">9</span><span id="t2c_49" class="t s8_49">. </span><span id="t2d_49" class="t s8_49">In retrospect, this design decision was probably a bad one: not only can it be confusing, but it </span>
<span id="t2e_49" class="t s8_49">forces JVM implementors to make tradeoffs between object size and locking performance. </span>
<span id="t2f_49" class="t s7_49">10</span><span id="t2g_49" class="t s8_49">. </span><span id="t2h_49" class="t s8_49">Code auditing tools like FindBugs can identify when a variable is frequently but not always </span>
<span id="t2i_49" class="t s8_49">accessed with a lock held, which may indicate a bug. </span></div>
<!-- End text definitions -->


</div>
</body>
</html>
