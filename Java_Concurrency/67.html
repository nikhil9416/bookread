<!DOCTYPE html>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=Edge" />
<meta charset="utf-8" />
</head>

<body style="margin: 0;">

<div id="p67" style="overflow: hidden; position: relative; background-color: white; width: 662px; height: 1017px;">

<!-- Begin shared CSS values -->
<style class="shared-css" type="text/css" >
.t {
	transform-origin: bottom left;
	z-index: 2;
	position: absolute;
	white-space: pre;
	overflow: visible;
	line-height: 1.5;
}
.text-container {
	white-space: pre;
}
@supports (-webkit-touch-callout: none) {
	.text-container {
		white-space: normal;
	}
}
</style>
<!-- End shared CSS values -->


<!-- Begin inline CSS -->
<style type="text/css" >

#t1_67{left:57px;bottom:942px;letter-spacing:0.2px;}
#t2_67{left:433px;bottom:942px;letter-spacing:0.13px;}
#t3_67{left:486px;bottom:942px;}
#t4_67{left:494px;bottom:942px;letter-spacing:0.09px;word-spacing:2.97px;}
#t5_67{left:57px;bottom:893px;letter-spacing:0.07px;word-spacing:2.69px;}
#t6_67{left:476px;bottom:893px;letter-spacing:0.1px;word-spacing:2.47px;}
#t7_67{left:57px;bottom:875px;letter-spacing:0.07px;word-spacing:3.22px;}
#t8_67{left:232px;bottom:876px;letter-spacing:0.05px;}
#t9_67{left:287px;bottom:875px;letter-spacing:0.1px;word-spacing:3.56px;}
#ta_67{left:57px;bottom:857px;letter-spacing:0.1px;word-spacing:0.52px;}
#tb_67{left:80px;bottom:839px;letter-spacing:0.09px;word-spacing:1.77px;}
#tc_67{left:57px;bottom:820px;letter-spacing:0.06px;word-spacing:1.59px;}
#td_67{left:57px;bottom:803px;letter-spacing:0.05px;}
#te_67{left:144px;bottom:802px;letter-spacing:0.09px;word-spacing:0.76px;}
#tf_67{left:57px;bottom:784px;letter-spacing:0.08px;word-spacing:0.46px;}
#tg_67{left:57px;bottom:766px;letter-spacing:0.11px;}
#th_67{left:80px;bottom:748px;letter-spacing:0.05px;}
#ti_67{left:171px;bottom:747px;letter-spacing:0.08px;word-spacing:0.5px;}
#tj_67{left:57px;bottom:729px;letter-spacing:0.11px;word-spacing:1.93px;}
#tk_67{left:113px;bottom:729px;}
#tl_67{left:121px;bottom:729px;letter-spacing:0.1px;word-spacing:1.68px;}
#tm_67{left:57px;bottom:711px;letter-spacing:0.1px;word-spacing:0.87px;}
#tn_67{left:551px;bottom:712px;letter-spacing:0.05px;}
#to_67{left:57px;bottom:693px;letter-spacing:0.05px;}
#tp_67{left:101px;bottom:692px;letter-spacing:0.1px;word-spacing:0.53px;}
#tq_67{left:57px;bottom:674px;letter-spacing:0.08px;word-spacing:0.88px;}
#tr_67{left:57px;bottom:657px;letter-spacing:0.05px;}
#ts_67{left:144px;bottom:656px;}
#tt_67{left:160px;bottom:656px;letter-spacing:0.09px;word-spacing:2.6px;}
#tu_67{left:57px;bottom:638px;letter-spacing:0.09px;word-spacing:0.23px;}
#tv_67{left:57px;bottom:620px;letter-spacing:0.06px;word-spacing:0.79px;}
#tw_67{left:80px;bottom:601px;letter-spacing:0.1px;word-spacing:0.33px;}
#tx_67{left:204px;bottom:602px;letter-spacing:0.05px;}
#ty_67{left:296px;bottom:601px;letter-spacing:0.09px;word-spacing:0.36px;}
#tz_67{left:57px;bottom:583px;letter-spacing:0.09px;word-spacing:0.43px;}
#t10_67{left:57px;bottom:565px;letter-spacing:0.1px;word-spacing:2.1px;}
#t11_67{left:57px;bottom:546px;letter-spacing:0.1px;word-spacing:3px;}
#t12_67{left:57px;bottom:528px;letter-spacing:0.12px;word-spacing:0.65px;}
#t13_67{left:57px;bottom:482px;}
#t14_67{left:66px;bottom:482px;}
#t15_67{left:71px;bottom:482px;}
#t16_67{left:98px;bottom:482px;letter-spacing:0.13px;}
#t17_67{left:57px;bottom:450px;letter-spacing:0.09px;word-spacing:2.74px;}
#t18_67{left:489px;bottom:450px;letter-spacing:0.11px;}
#t19_67{left:561px;bottom:450px;letter-spacing:0.08px;}
#t1a_67{left:57px;bottom:432px;letter-spacing:0.13px;word-spacing:1.71px;}
#t1b_67{left:118px;bottom:432px;letter-spacing:0.2px;}
#t1c_67{left:134px;bottom:432px;letter-spacing:0.09px;word-spacing:2.07px;}
#t1d_67{left:57px;bottom:413px;letter-spacing:0.07px;word-spacing:2.27px;}
#t1e_67{left:57px;bottom:395px;letter-spacing:0.07px;word-spacing:1.76px;}
#t1f_67{left:57px;bottom:377px;letter-spacing:0.11px;word-spacing:2.54px;}
#t1g_67{left:406px;bottom:377px;letter-spacing:0.1px;word-spacing:2.55px;}
#t1h_67{left:57px;bottom:358px;letter-spacing:0.01px;word-spacing:0.87px;}
#t1i_67{left:80px;bottom:340px;letter-spacing:0.1px;word-spacing:0.41px;}
#t1j_67{left:57px;bottom:322px;letter-spacing:0.09px;word-spacing:1.59px;}
#t1k_67{left:57px;bottom:304px;letter-spacing:0.04px;word-spacing:0.16px;}
#t1l_67{left:182px;bottom:253px;letter-spacing:-0.26px;word-spacing:-0.11px;}
#t1m_67{left:80px;bottom:203px;letter-spacing:0.1px;word-spacing:0.42px;}
#t1n_67{left:233px;bottom:203px;letter-spacing:0.11px;}
#t1o_67{left:272px;bottom:203px;letter-spacing:0.09px;word-spacing:0.52px;}
#t1p_67{left:57px;bottom:185px;word-spacing:3.51px;}
#t1q_67{left:276px;bottom:185px;letter-spacing:0.09px;word-spacing:3.29px;}
#t1r_67{left:57px;bottom:167px;letter-spacing:0.08px;word-spacing:0.51px;}
#t1s_67{left:57px;bottom:149px;letter-spacing:0.08px;word-spacing:0.73px;}
#t1t_67{left:80px;bottom:130px;letter-spacing:0.11px;word-spacing:1.21px;}
#t1u_67{left:267px;bottom:130px;letter-spacing:0.05px;}
#t1v_67{left:296px;bottom:130px;letter-spacing:0.09px;word-spacing:1.69px;}
#t1w_67{left:57px;bottom:112px;letter-spacing:0.1px;word-spacing:2.69px;}
#t1x_67{left:57px;bottom:94px;letter-spacing:0.07px;word-spacing:1.43px;}
#t1y_67{left:57px;bottom:76px;letter-spacing:0.09px;word-spacing:0.88px;}
#t1z_67{left:57px;bottom:57px;letter-spacing:0.07px;word-spacing:0.99px;}

.s0_67{font-size:15px;font-family:TeXPalladioL-SC_amc;color:#000;}
.s1_67{font-size:15px;font-family:Palatino-Italic_amd;color:#000;}
.s2_67{font-size:15px;font-family:TeXPalladioL-ItalicOsF_amn;color:#000;}
.s3_67{font-size:15px;font-family:Palatino-Roman_ame;color:#000;}
.s4_67{font-size:13px;font-family:LucidaSansTypewriter_amm;color:#000;}
.s5_67{font-size:18px;font-family:TeXPalladioL-BoldOsF_aml;color:#000;}
.s6_67{font-size:18px;font-family:Palatino-Bold_amf;color:#000;}
.s7_67{font-size:15px;font-family:LucidaSans_amq;color:#000;}
</style>
<!-- End inline CSS -->

<!-- Begin embedded font definitions -->
<style id="fonts67" type="text/css" >

@font-face {
	font-family: LucidaSansTypewriter_amm;
	src: url("fonts/LucidaSansTypewriter_amm.woff") format("woff");
}

@font-face {
	font-family: LucidaSans_amq;
	src: url("fonts/LucidaSans_amq.woff") format("woff");
}

@font-face {
	font-family: Palatino-Bold_amf;
	src: url("fonts/Palatino-Bold_amf.woff") format("woff");
}

@font-face {
	font-family: Palatino-Italic_amd;
	src: url("fonts/Palatino-Italic_amd.woff") format("woff");
}

@font-face {
	font-family: Palatino-Roman_ame;
	src: url("fonts/Palatino-Roman_ame.woff") format("woff");
}

@font-face {
	font-family: TeXPalladioL-BoldOsF_aml;
	src: url("fonts/TeXPalladioL-BoldOsF_aml.woff") format("woff");
}

@font-face {
	font-family: TeXPalladioL-ItalicOsF_amn;
	src: url("fonts/TeXPalladioL-ItalicOsF_amn.woff") format("woff");
}

@font-face {
	font-family: TeXPalladioL-SC_amc;
	src: url("fonts/TeXPalladioL-SC_amc.woff") format("woff");
}

</style>
<!-- End embedded font definitions -->

<!-- Begin page background -->
<div id="pg67Overlay" style="width:100%; height:100%; position:absolute; z-index:1; background-color:rgba(0,0,0,0); -webkit-user-select: none;"></div>
<div id="pg67" style="-webkit-user-select: none;"><object width="662" height="1017" data="67/67.svg" type="image/svg+xml" id="pdf67" style="width:662px; height:1017px; -moz-transform:scale(1); z-index: 0;"></object></div>
<!-- End page background -->


<!-- Begin text definitions (Positioned/styled in CSS) -->
<div class="text-container"><span id="t1_67" class="t s0_67">46 </span><span id="t2_67" class="t s1_67">Chapter </span><span id="t3_67" class="t s2_67">3</span><span id="t4_67" class="t s1_67">. Sharing Objects </span>
<span id="t5_67" class="t s3_67">values, though this is not how it is actually implemented. </span><span id="t6_67" class="t s3_67" data-mappings='[[16,"fi"]]'>The thread-speciﬁc </span>
<span id="t7_67" class="t s3_67">values are stored in the </span><span id="t8_67" class="t s4_67">Thread </span><span id="t9_67" class="t s3_67">object itself; when the thread terminates, the </span>
<span id="ta_67" class="t s3_67" data-mappings='[[12,"fi"]]'>thread-speciﬁc values can be garbage collected. </span>
<span id="tb_67" class="t s3_67">If you are porting a single-threaded application to a multithreaded environ- </span>
<span id="tc_67" class="t s3_67">ment, you can preserve thread safety by converting shared global variables into </span>
<span id="td_67" class="t s4_67">ThreadLocal</span><span id="te_67" class="t s3_67">s, if the semantics of the shared globals permits this; an application- </span>
<span id="tf_67" class="t s3_67">wide cache would not be as useful if it were turned into a number of thread-local </span>
<span id="tg_67" class="t s3_67">caches. </span>
<span id="th_67" class="t s4_67">ThreadLocal </span><span id="ti_67" class="t s3_67">is widely used in implementing application frameworks. For ex- </span>
<span id="tj_67" class="t s3_67">ample, J</span><span id="tk_67" class="t s0_67">2</span><span id="tl_67" class="t s3_67">EE containers associate a transaction context with an executing thread </span>
<span id="tm_67" class="t s3_67">for the duration of an EJB call. This is easily implemented using a static </span><span id="tn_67" class="t s4_67">Thread- </span>
<span id="to_67" class="t s4_67">Local </span><span id="tp_67" class="t s3_67">holding the transaction context: when framework code needs to determine </span>
<span id="tq_67" class="t s3_67">what transaction is currently running, it fetches the transaction context from this </span>
<span id="tr_67" class="t s4_67">ThreadLocal</span><span id="ts_67" class="t s3_67">. </span><span id="tt_67" class="t s3_67">This is convenient in that it reduces the need to pass execution </span>
<span id="tu_67" class="t s3_67">context information into every method, but couples any code that uses this mech- </span>
<span id="tv_67" class="t s3_67">anism to the framework. </span>
<span id="tw_67" class="t s3_67">It is easy to abuse </span><span id="tx_67" class="t s4_67">ThreadLocal </span><span id="ty_67" class="t s3_67" data-mappings='[[26,"fi"]]'>by treating its thread conﬁnement property as </span>
<span id="tz_67" class="t s3_67">a license to use global variables or as a means of creating “hidden” method argu- </span>
<span id="t10_67" class="t s3_67">ments. Like global variables, thread-local variables can detract from reusability </span>
<span id="t11_67" class="t s3_67">and introduce hidden couplings among classes, and should therefore be used </span>
<span id="t12_67" class="t s3_67">with care. </span>
<span id="t13_67" class="t s5_67">3</span><span id="t14_67" class="t s6_67">.</span><span id="t15_67" class="t s5_67">4 </span><span id="t16_67" class="t s6_67">Immutability </span>
<span id="t17_67" class="t s3_67">The other end-run around the need to synchronize is to use </span><span id="t18_67" class="t s1_67">immutable </span><span id="t19_67" class="t s3_67">objects </span>
<span id="t1a_67" class="t s3_67">[EJ Item </span><span id="t1b_67" class="t s0_67">13</span><span id="t1c_67" class="t s3_67">]. Nearly all the atomicity and visibility hazards we’ve described so </span>
<span id="t1d_67" class="t s3_67">far, such as seeing stale values, losing updates, or observing an object to be in </span>
<span id="t1e_67" class="t s3_67">an inconsistent state, have to do with the vagaries of multiple threads trying to </span>
<span id="t1f_67" class="t s3_67">access the same mutable state at the same time. </span><span id="t1g_67" class="t s3_67">If an object’s state cannot be </span>
<span id="t1h_67" class="t s3_67" data-mappings='[[4,"fi"]]'>modiﬁed, these risks and complexities simply go away. </span>
<span id="t1i_67" class="t s3_67">An immutable object is one whose state cannot be changed after construction. </span>
<span id="t1j_67" class="t s3_67">Immutable objects are inherently thread-safe; their invariants are established by </span>
<span id="t1k_67" class="t s3_67">the constructor, and if their state cannot be changed, these invariants always hold. </span>
<span id="t1l_67" class="t s7_67">Immutable objects are always thread-safe. </span>
<span id="t1m_67" class="t s3_67">Immutable objects are </span><span id="t1n_67" class="t s1_67">simple</span><span id="t1o_67" class="t s3_67">. They can only be in one state, which is carefully </span>
<span id="t1p_67" class="t s3_67">controlled by the constructor. </span><span id="t1q_67" class="t s3_67" data-mappings='[[19,"fi"]]'>One of the most difﬁcult elements of program </span>
<span id="t1r_67" class="t s3_67">design is reasoning about the possible states of complex objects. Reasoning about </span>
<span id="t1s_67" class="t s3_67">the state of immutable objects, on the other hand, is trivial. </span>
<span id="t1t_67" class="t s3_67">Immutable objects are also </span><span id="t1u_67" class="t s1_67">safer</span><span id="t1v_67" class="t s3_67">. Passing a mutable object to untrusted code, </span>
<span id="t1w_67" class="t s3_67" data-mappings='[[54,"fi"]]'>or otherwise publishing it where untrusted code could ﬁnd it, is dangerous— </span>
<span id="t1x_67" class="t s3_67">the untrusted code might modify its state, or, worse, retain a reference to it and </span>
<span id="t1y_67" class="t s3_67">modify its state later from another thread. On the other hand, immutable objects </span>
<span id="t1z_67" class="t s3_67">cannot be subverted in this manner by malicious or buggy code, so they are safe </span></div>
<!-- End text definitions -->


</div>
</body>
</html>
