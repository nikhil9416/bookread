<!DOCTYPE html>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=Edge" />
<meta charset="utf-8" />
</head>

<body style="margin: 0;">

<div id="p159" style="overflow: hidden; position: relative; background-color: white; width: 662px; height: 1017px;">

<!-- Begin shared CSS values -->
<style class="shared-css" type="text/css" >
.t {
	transform-origin: bottom left;
	z-index: 2;
	position: absolute;
	white-space: pre;
	overflow: visible;
	line-height: 1.5;
}
.text-container {
	white-space: pre;
}
@supports (-webkit-touch-callout: none) {
	.text-container {
		white-space: normal;
	}
}
</style>
<!-- End shared CSS values -->


<!-- Begin inline CSS -->
<style type="text/css" >

#t1_159{left:57px;bottom:942px;letter-spacing:0.2px;}
#t2_159{left:360px;bottom:942px;letter-spacing:0.13px;}
#t3_159{left:414px;bottom:942px;}
#t4_159{left:421px;bottom:942px;letter-spacing:0.12px;word-spacing:2.04px;}
#t5_159{left:57px;bottom:893px;letter-spacing:0.06px;word-spacing:2.66px;}
#t6_159{left:57px;bottom:875px;letter-spacing:0.05px;word-spacing:0.3px;}
#t7_159{left:57px;bottom:857px;letter-spacing:0.1px;word-spacing:0.57px;}
#t8_159{left:80px;bottom:840px;letter-spacing:0.05px;}
#t9_159{left:195px;bottom:839px;letter-spacing:0.09px;word-spacing:0.25px;}
#ta_159{left:57px;bottom:820px;letter-spacing:0.04px;word-spacing:1.22px;}
#tb_159{left:171px;bottom:821px;letter-spacing:0.05px;}
#tc_159{left:219px;bottom:820px;}
#td_159{left:228px;bottom:821px;letter-spacing:0.07px;}
#te_159{left:344px;bottom:820px;letter-spacing:0.11px;word-spacing:0.94px;}
#tf_159{left:57px;bottom:802px;letter-spacing:0.11px;word-spacing:0.59px;}
#tg_159{left:57px;bottom:760px;}
#th_159{left:65px;bottom:760px;}
#ti_159{left:69px;bottom:760px;}
#tj_159{left:78px;bottom:760px;}
#tk_159{left:82px;bottom:760px;}
#tl_159{left:107px;bottom:760px;letter-spacing:-0.14px;}
#tm_159{left:57px;bottom:732px;letter-spacing:0.1px;word-spacing:0.83px;}
#tn_159{left:272px;bottom:733px;letter-spacing:0.07px;}
#to_159{left:388px;bottom:732px;letter-spacing:0.07px;word-spacing:0.9px;}
#tp_159{left:57px;bottom:714px;letter-spacing:0.04px;word-spacing:1.95px;}
#tq_159{left:57px;bottom:695px;letter-spacing:0.1px;word-spacing:2.73px;}
#tr_159{left:359px;bottom:696px;letter-spacing:0.06px;}
#ts_159{left:493px;bottom:695px;letter-spacing:-0.11px;word-spacing:3.63px;}
#tt_159{left:57px;bottom:677px;letter-spacing:0.08px;word-spacing:2.62px;}
#tu_159{left:57px;bottom:659px;letter-spacing:0.08px;word-spacing:0.59px;}
#tv_159{left:80px;bottom:642px;letter-spacing:0.08px;}
#tw_159{left:238px;bottom:641px;letter-spacing:0.08px;word-spacing:2.78px;}
#tx_159{left:311px;bottom:641px;}
#ty_159{left:318px;bottom:641px;}
#tz_159{left:322px;bottom:641px;}
#t10_159{left:336px;bottom:641px;letter-spacing:0.09px;word-spacing:2.77px;}
#t11_159{left:513px;bottom:641px;letter-spacing:0.09px;word-spacing:2.7px;}
#t12_159{left:57px;bottom:622px;letter-spacing:0.1px;word-spacing:2.11px;}
#t13_159{left:57px;bottom:604px;letter-spacing:0.06px;word-spacing:3.15px;}
#t14_159{left:454px;bottom:605px;letter-spacing:0.05px;}
#t15_159{left:484px;bottom:604px;letter-spacing:0.07px;word-spacing:3.02px;}
#t16_159{left:570px;bottom:604px;letter-spacing:0.14px;}
#t17_159{left:57px;bottom:586px;letter-spacing:0.09px;word-spacing:1.71px;}
#t18_159{left:57px;bottom:569px;letter-spacing:0.05px;}
#t19_159{left:81px;bottom:568px;letter-spacing:0.12px;word-spacing:1.38px;}
#t1a_159{left:165px;bottom:569px;letter-spacing:0.05px;}
#t1b_159{left:217px;bottom:568px;letter-spacing:0.07px;word-spacing:1.06px;}
#t1c_159{left:344px;bottom:569px;letter-spacing:0.05px;}
#t1d_159{left:420px;bottom:568px;letter-spacing:0.09px;word-spacing:0.99px;}
#t1e_159{left:57px;bottom:549px;letter-spacing:0.05px;word-spacing:0.8px;}
#t1f_159{left:520px;bottom:550px;letter-spacing:0.05px;}
#t1g_159{left:548px;bottom:549px;letter-spacing:0.14px;}
#t1h_159{left:57px;bottom:531px;letter-spacing:0.09px;word-spacing:0.68px;}
#t1i_159{left:80px;bottom:513px;letter-spacing:0.07px;word-spacing:2.56px;}
#t1j_159{left:261px;bottom:513px;}
#t1k_159{left:268px;bottom:513px;letter-spacing:0.11px;word-spacing:2.58px;}
#t1l_159{left:572px;bottom:513px;letter-spacing:0.06px;}
#t1m_159{left:57px;bottom:494px;letter-spacing:0.12px;}
#t1n_159{left:103px;bottom:494px;}
#t1o_159{left:117px;bottom:494px;letter-spacing:0.09px;word-spacing:2.21px;}
#t1p_159{left:57px;bottom:476px;letter-spacing:0.08px;word-spacing:0.66px;}
#t1q_159{left:57px;bottom:458px;letter-spacing:0.09px;word-spacing:0.7px;}
#t1r_159{left:72px;bottom:407px;letter-spacing:-0.22px;word-spacing:-0.31px;}
#t1s_159{left:72px;bottom:387px;letter-spacing:-0.23px;word-spacing:0.34px;}
#t1t_159{left:72px;bottom:366px;letter-spacing:-0.23px;word-spacing:1.91px;}
#t1u_159{left:72px;bottom:345px;letter-spacing:-0.22px;}
#t1v_159{left:80px;bottom:296px;letter-spacing:0.13px;word-spacing:1.16px;}
#t1w_159{left:266px;bottom:296px;letter-spacing:0.09px;word-spacing:1.09px;}
#t1x_159{left:378px;bottom:296px;letter-spacing:0.09px;word-spacing:1.36px;}
#t1y_159{left:57px;bottom:277px;letter-spacing:0.11px;word-spacing:1.26px;}
#t1z_159{left:228px;bottom:278px;letter-spacing:0.05px;}
#t20_159{left:281px;bottom:277px;letter-spacing:0.1px;word-spacing:1.36px;}
#t21_159{left:57px;bottom:259px;letter-spacing:0.09px;word-spacing:1.15px;}
#t22_159{left:498px;bottom:259px;}
#t23_159{left:506px;bottom:259px;}
#t24_159{left:510px;bottom:259px;}
#t25_159{left:518px;bottom:259px;letter-spacing:0.1px;word-spacing:3.04px;}
#t26_159{left:559px;bottom:260px;letter-spacing:0.06px;}
#t27_159{left:57px;bottom:242px;letter-spacing:0.05px;}
#t28_159{left:94px;bottom:241px;letter-spacing:0.1px;word-spacing:1.63px;}
#t29_159{left:380px;bottom:242px;letter-spacing:0.05px;}
#t2a_159{left:489px;bottom:241px;letter-spacing:0.09px;word-spacing:1.61px;}
#t2b_159{left:57px;bottom:223px;letter-spacing:0.09px;word-spacing:0.86px;}
#t2c_159{left:462px;bottom:224px;letter-spacing:0.05px;}
#t2d_159{left:554px;bottom:223px;letter-spacing:0.1px;}
#t2e_159{left:57px;bottom:204px;letter-spacing:0.06px;}
#t2f_159{left:97px;bottom:204px;letter-spacing:0.09px;word-spacing:1.08px;}
#t2g_159{left:57px;bottom:186px;letter-spacing:0.05px;word-spacing:0.73px;}
#t2h_159{left:80px;bottom:168px;letter-spacing:0.1px;word-spacing:2.45px;}
#t2i_159{left:293px;bottom:169px;letter-spacing:0.05px;}
#t2j_159{left:394px;bottom:168px;letter-spacing:0.14px;}
#t2k_159{left:426px;bottom:169px;letter-spacing:0.05px;}
#t2l_159{left:520px;bottom:168px;letter-spacing:0.14px;word-spacing:2.39px;}
#t2m_159{left:57px;bottom:150px;letter-spacing:0.07px;word-spacing:2.87px;}
#t2n_159{left:447px;bottom:150px;letter-spacing:0.09px;word-spacing:2.79px;}
#t2o_159{left:57px;bottom:131px;letter-spacing:0.06px;word-spacing:1.17px;}
#t2p_159{left:443px;bottom:132px;letter-spacing:0.08px;}
#t2q_159{left:602px;bottom:131px;}
#t2r_159{left:57px;bottom:113px;letter-spacing:0.09px;word-spacing:1.78px;}
#t2s_159{left:57px;bottom:95px;letter-spacing:0.09px;word-spacing:1.87px;}
#t2t_159{left:57px;bottom:76px;letter-spacing:0.05px;word-spacing:0.7px;}

.s0_159{font-size:15px;font-family:TeXPalladioL-SC_amc;color:#000;}
.s1_159{font-size:15px;font-family:Palatino-Italic_amd;color:#000;}
.s2_159{font-size:15px;font-family:TeXPalladioL-ItalicOsF_amn;color:#000;}
.s3_159{font-size:15px;font-family:Palatino-Roman_ame;color:#000;}
.s4_159{font-size:13px;font-family:LucidaSansTypewriter_amm;color:#000;}
.s5_159{font-size:17px;font-family:TeXPalladioL-BoldOsF_aml;color:#000;}
.s6_159{font-size:17px;font-family:Palatino-Bold_amf;color:#000;}
.s7_159{font-size:15px;font-family:LucidaSans_amq;color:#000;}
</style>
<!-- End inline CSS -->

<!-- Begin embedded font definitions -->
<style id="fonts159" type="text/css" >

@font-face {
	font-family: LucidaSansTypewriter_amm;
	src: url("fonts/LucidaSansTypewriter_amm.woff") format("woff");
}

@font-face {
	font-family: LucidaSans_amq;
	src: url("fonts/LucidaSans_amq.woff") format("woff");
}

@font-face {
	font-family: Palatino-Bold_amf;
	src: url("fonts/Palatino-Bold_amf.woff") format("woff");
}

@font-face {
	font-family: Palatino-Italic_amd;
	src: url("fonts/Palatino-Italic_amd.woff") format("woff");
}

@font-face {
	font-family: Palatino-Roman_ame;
	src: url("fonts/Palatino-Roman_ame.woff") format("woff");
}

@font-face {
	font-family: TeXPalladioL-BoldOsF_aml;
	src: url("fonts/TeXPalladioL-BoldOsF_aml.woff") format("woff");
}

@font-face {
	font-family: TeXPalladioL-ItalicOsF_amn;
	src: url("fonts/TeXPalladioL-ItalicOsF_amn.woff") format("woff");
}

@font-face {
	font-family: TeXPalladioL-SC_amc;
	src: url("fonts/TeXPalladioL-SC_amc.woff") format("woff");
}

</style>
<!-- End embedded font definitions -->

<!-- Begin page background -->
<div id="pg159Overlay" style="width:100%; height:100%; position:absolute; z-index:1; background-color:rgba(0,0,0,0); -webkit-user-select: none;"></div>
<div id="pg159" style="-webkit-user-select: none;"><object width="662" height="1017" data="159/159.svg" type="image/svg+xml" id="pdf159" style="width:662px; height:1017px; -moz-transform:scale(1); z-index: 0;"></object></div>
<!-- End page background -->


<!-- Begin text definitions (Positioned/styled in CSS) -->
<div class="text-container"><span id="t1_159" class="t s0_159">138 </span><span id="t2_159" class="t s1_159">Chapter </span><span id="t3_159" class="t s2_159">7</span><span id="t4_159" class="t s1_159">. Cancellation and Shutdown </span>
<span id="t5_159" class="t s3_159">payment is actually stopped (such as notifying the other bank involved in the </span>
<span id="t6_159" class="t s3_159">transaction and assessing a fee against the payor’s account). Taken together, these </span>
<span id="t7_159" class="t s3_159">procedures and guarantees comprise the cancellation policy for check payment. </span>
<span id="t8_159" class="t s4_159">PrimeGenerator </span><span id="t9_159" class="t s3_159">uses a simple cancellation policy: client code requests cancel- </span>
<span id="ta_159" class="t s3_159">lation by calling </span><span id="tb_159" class="t s4_159">cancel</span><span id="tc_159" class="t s3_159">, </span><span id="td_159" class="t s4_159">PrimeGenerator </span><span id="te_159" class="t s3_159">checks for cancellation once per prime </span>
<span id="tf_159" class="t s3_159">found and exits when it detects cancellation has been requested. </span>
<span id="tg_159" class="t s5_159">7</span><span id="th_159" class="t s6_159">.</span><span id="ti_159" class="t s5_159">1</span><span id="tj_159" class="t s6_159">.</span><span id="tk_159" class="t s5_159">1 </span><span id="tl_159" class="t s6_159">Interruption </span>
<span id="tm_159" class="t s3_159">The cancellation mechanism in </span><span id="tn_159" class="t s4_159">PrimeGenerator </span><span id="to_159" class="t s3_159">will eventually cause the prime- </span>
<span id="tp_159" class="t s3_159">seeking task to exit, but it might take a while. If, however, a task that uses this </span>
<span id="tq_159" class="t s3_159">approach calls a blocking method such as </span><span id="tr_159" class="t s4_159">BlockingQueue.put</span><span id="ts_159" class="t s3_159">, we could have </span>
<span id="tt_159" class="t s3_159">a more serious problem—the task might never check the cancellation ﬂag and </span>
<span id="tu_159" class="t s3_159">therefore might never terminate. </span>
<span id="tv_159" class="t s4_159">BrokenPrimeProducer </span><span id="tw_159" class="t s3_159">in Listing </span><span id="tx_159" class="t s0_159">7</span><span id="ty_159" class="t s3_159">.</span><span id="tz_159" class="t s0_159">3 </span><span id="t10_159" class="t s3_159">illustrates this problem. </span><span id="t11_159" class="t s3_159">The producer </span>
<span id="t12_159" class="t s3_159">thread generates primes and places them on a blocking queue. If the producer </span>
<span id="t13_159" class="t s3_159" data-mappings='[[43,"fi"]]'>gets ahead of the consumer, the queue will ﬁll up and </span><span id="t14_159" class="t s4_159">put </span><span id="t15_159" class="t s3_159">will block. </span><span id="t16_159" class="t s3_159">What </span>
<span id="t17_159" class="t s3_159">happens if the consumer tries to cancel the producer task while it is blocked in </span>
<span id="t18_159" class="t s4_159">put</span><span id="t19_159" class="t s3_159">? It can call </span><span id="t1a_159" class="t s4_159">cancel </span><span id="t1b_159" class="t s3_159">which will set the </span><span id="t1c_159" class="t s4_159">cancelled </span><span id="t1d_159" class="t s3_159">ﬂag—but the producer will </span>
<span id="t1e_159" class="t s3_159">never check the ﬂag because it will never emerge from the blocking </span><span id="t1f_159" class="t s4_159">put </span><span id="t1g_159" class="t s3_159">(because </span>
<span id="t1h_159" class="t s3_159">the consumer has stopped retrieving primes from the queue). </span>
<span id="t1i_159" class="t s3_159">As we hinted in Chapter </span><span id="t1j_159" class="t s0_159">5</span><span id="t1k_159" class="t s3_159">, certain blocking library methods support </span><span id="t1l_159" class="t s1_159">inter- </span>
<span id="t1m_159" class="t s1_159">ruption</span><span id="t1n_159" class="t s3_159">. </span><span id="t1o_159" class="t s3_159">Thread interruption is a cooperative mechanism for a thread to signal </span>
<span id="t1p_159" class="t s3_159">another thread that it should, at its convenience and if it feels like it, stop what it </span>
<span id="t1q_159" class="t s3_159">is doing and do something else. </span>
<span id="t1r_159" class="t s7_159" data-mappings='[[45,"fi"]]'>There is nothing in the API or language speciﬁcation that ties interruption </span>
<span id="t1s_159" class="t s7_159" data-mappings='[[12,"fi"]]'>to any speciﬁc cancellation semantics, but in practice, using interruption </span>
<span id="t1t_159" class="t s7_159">for anything but cancellation is fragile and diﬃcult to sustain in larger </span>
<span id="t1u_159" class="t s7_159">applications. </span>
<span id="t1v_159" class="t s3_159">Each thread has a boolean </span><span id="t1w_159" class="t s1_159">interrupted status</span><span id="t1x_159" class="t s3_159">; interrupting a thread sets its in- </span>
<span id="t1y_159" class="t s3_159">terrupted status to true. </span><span id="t1z_159" class="t s4_159">Thread </span><span id="t20_159" class="t s3_159">contains methods for interrupting a thread and </span>
<span id="t21_159" class="t s3_159">querying the interrupted status of a thread, as shown in Listing </span><span id="t22_159" class="t s0_159">7</span><span id="t23_159" class="t s3_159">.</span><span id="t24_159" class="t s0_159">4</span><span id="t25_159" class="t s3_159">. The </span><span id="t26_159" class="t s4_159">inter- </span>
<span id="t27_159" class="t s4_159">rupt </span><span id="t28_159" class="t s3_159">method interrupts the target thread, and </span><span id="t29_159" class="t s4_159">isInterrupted </span><span id="t2a_159" class="t s3_159">returns the inter- </span>
<span id="t2b_159" class="t s3_159">rupted status of the target thread. The poorly named static </span><span id="t2c_159" class="t s4_159">interrupted </span><span id="t2d_159" class="t s3_159">method </span>
<span id="t2e_159" class="t s1_159">clears </span><span id="t2f_159" class="t s3_159">the interrupted status of the current thread and returns its previous value; </span>
<span id="t2g_159" class="t s3_159">this is the only way to clear the interrupted status. </span>
<span id="t2h_159" class="t s3_159">Blocking library methods like </span><span id="t2i_159" class="t s4_159">Thread.sleep </span><span id="t2j_159" class="t s3_159">and </span><span id="t2k_159" class="t s4_159">Object.wait </span><span id="t2l_159" class="t s3_159">try to detect </span>
<span id="t2m_159" class="t s3_159">when a thread has been interrupted and return early. </span><span id="t2n_159" class="t s3_159">They respond to inter- </span>
<span id="t2o_159" class="t s3_159">ruption by clearing the interrupted status and throwing </span><span id="t2p_159" class="t s4_159">InterruptedException</span><span id="t2q_159" class="t s3_159">, </span>
<span id="t2r_159" class="t s3_159">indicating that the blocking operation completed early due to interruption. The </span>
<span id="t2s_159" class="t s3_159">JVM makes no guarantees on how quickly a blocking method will detect inter- </span>
<span id="t2t_159" class="t s3_159">ruption, but in practice this happens reasonably quickly. </span></div>
<!-- End text definitions -->


</div>
</body>
</html>
