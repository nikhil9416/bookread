<!DOCTYPE html>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=Edge" />
<meta charset="utf-8" />
</head>

<body style="margin: 0;">

<div id="p92" style="overflow: hidden; position: relative; background-color: white; width: 662px; height: 1017px;">

<!-- Begin shared CSS values -->
<style class="shared-css" type="text/css" >
.t {
	transform-origin: bottom left;
	z-index: 2;
	position: absolute;
	white-space: pre;
	overflow: visible;
	line-height: 1.5;
}
.text-container {
	white-space: pre;
}
@supports (-webkit-touch-callout: none) {
	.text-container {
		white-space: normal;
	}
}
</style>
<!-- End shared CSS values -->


<!-- Begin inline CSS -->
<style type="text/css" >

#t1_92{left:57px;bottom:942px;}
#t2_92{left:65px;bottom:942px;}
#t3_92{left:68px;bottom:942px;}
#t4_92{left:76px;bottom:942px;letter-spacing:0.1px;word-spacing:1.14px;}
#t5_92{left:591px;bottom:942px;letter-spacing:0.2px;}
#t6_92{left:57px;bottom:893px;letter-spacing:0.08px;word-spacing:1.82px;}
#t7_92{left:57px;bottom:875px;letter-spacing:-0.41px;}
#t8_92{left:78px;bottom:876px;letter-spacing:0.09px;}
#t9_92{left:274px;bottom:875px;letter-spacing:0.06px;word-spacing:0.76px;}
#ta_92{left:57px;bottom:829px;}
#tb_92{left:66px;bottom:829px;}
#tc_92{left:71px;bottom:829px;}
#td_92{left:98px;bottom:829px;letter-spacing:0.12px;word-spacing:0.77px;}
#te_92{left:57px;bottom:797px;letter-spacing:0.09px;word-spacing:2.65px;}
#tf_92{left:551px;bottom:797px;letter-spacing:0.1px;}
#tg_92{left:57px;bottom:778px;letter-spacing:0.11px;word-spacing:2.75px;}
#th_92{left:57px;bottom:760px;letter-spacing:0.08px;word-spacing:0.46px;}
#ti_92{left:57px;bottom:742px;letter-spacing:0.11px;word-spacing:1.01px;}
#tj_92{left:57px;bottom:724px;letter-spacing:0.06px;word-spacing:2.05px;}
#tk_92{left:57px;bottom:706px;letter-spacing:0.1px;word-spacing:1.13px;}
#tl_92{left:153px;bottom:706px;letter-spacing:0.11px;}
#tm_92{left:198px;bottom:706px;letter-spacing:0.04px;word-spacing:1.21px;}
#tn_92{left:57px;bottom:687px;letter-spacing:0.06px;word-spacing:0.75px;}
#to_92{left:80px;bottom:669px;letter-spacing:0.1px;word-spacing:2.21px;}
#tp_92{left:415px;bottom:670px;letter-spacing:0.05px;}
#tq_92{left:452px;bottom:669px;letter-spacing:0.1px;word-spacing:2.21px;}
#tr_92{left:57px;bottom:651px;letter-spacing:0.1px;word-spacing:3.14px;}
#ts_92{left:189px;bottom:651px;letter-spacing:0.08px;word-spacing:3.46px;}
#tt_92{left:320px;bottom:652px;letter-spacing:0.05px;}
#tu_92{left:359px;bottom:651px;letter-spacing:0.1px;word-spacing:3.24px;}
#tv_92{left:57px;bottom:632px;letter-spacing:0.04px;word-spacing:0.48px;}
#tw_92{left:210px;bottom:633px;letter-spacing:0.05px;}
#tx_92{left:278px;bottom:632px;letter-spacing:0.14px;}
#ty_92{left:308px;bottom:633px;letter-spacing:0.05px;}
#tz_92{left:336px;bottom:632px;letter-spacing:0.07px;word-spacing:0.41px;}
#t10_92{left:57px;bottom:614px;letter-spacing:0.11px;word-spacing:0.32px;}
#t11_92{left:80px;bottom:596px;letter-spacing:0.1px;word-spacing:2.96px;}
#t12_92{left:57px;bottom:578px;letter-spacing:0.09px;word-spacing:-0.11px;}
#t13_92{left:57px;bottom:559px;letter-spacing:0.03px;word-spacing:1.09px;}
#t14_92{left:57px;bottom:541px;letter-spacing:0.1px;word-spacing:-0.13px;}
#t15_92{left:57px;bottom:523px;letter-spacing:0.1px;word-spacing:1.79px;}
#t16_92{left:201px;bottom:523px;letter-spacing:0.13px;}
#t17_92{left:242px;bottom:523px;letter-spacing:0.09px;word-spacing:2.35px;}
#t18_92{left:57px;bottom:505px;letter-spacing:0.12px;word-spacing:1.49px;}
#t19_92{left:104px;bottom:505px;letter-spacing:0.05px;}
#t1a_92{left:141px;bottom:505px;letter-spacing:0.09px;word-spacing:1.63px;}
#t1b_92{left:337px;bottom:505px;}
#t1c_92{left:349px;bottom:505px;letter-spacing:0.15px;word-spacing:1.57px;}
#t1d_92{left:421px;bottom:505px;}
#t1e_92{left:438px;bottom:505px;letter-spacing:0.09px;word-spacing:1.68px;}
#t1f_92{left:57px;bottom:486px;letter-spacing:0.06px;word-spacing:2.32px;}
#t1g_92{left:407px;bottom:486px;}
#t1h_92{left:418px;bottom:486px;}
#t1i_92{left:432px;bottom:486px;letter-spacing:0.08px;word-spacing:2.27px;}
#t1j_92{left:57px;bottom:468px;letter-spacing:0.08px;word-spacing:0.54px;}
#t1k_92{left:538px;bottom:468px;}
#t1l_92{left:554px;bottom:468px;letter-spacing:-0.05px;word-spacing:0.87px;}
#t1m_92{left:57px;bottom:450px;letter-spacing:0.12px;word-spacing:0.54px;}
#t1n_92{left:207px;bottom:450px;}
#t1o_92{left:219px;bottom:450px;letter-spacing:0.05px;word-spacing:0.72px;}
#t1p_92{left:404px;bottom:450px;}
#t1q_92{left:416px;bottom:450px;}
#t1r_92{left:80px;bottom:432px;letter-spacing:0.08px;word-spacing:1.28px;}
#t1s_92{left:57px;bottom:413px;letter-spacing:0.05px;word-spacing:0.52px;}
#t1t_92{left:57px;bottom:395px;letter-spacing:0.05px;word-spacing:2.17px;}
#t1u_92{left:536px;bottom:395px;letter-spacing:-0.01px;word-spacing:2.4px;}
#t1v_92{left:57px;bottom:377px;letter-spacing:0.08px;word-spacing:0.68px;}
#t1w_92{left:57px;bottom:358px;letter-spacing:0.07px;word-spacing:0.48px;}
#t1x_92{left:57px;bottom:340px;letter-spacing:0.09px;}
#t1y_92{left:117px;bottom:340px;letter-spacing:0.1px;word-spacing:2.72px;}
#t1z_92{left:57px;bottom:322px;letter-spacing:0.08px;word-spacing:0.86px;}
#t20_92{left:57px;bottom:304px;letter-spacing:0.09px;word-spacing:0.69px;}
#t21_92{left:80px;bottom:286px;letter-spacing:0.09px;word-spacing:1.08px;}
#t22_92{left:57px;bottom:267px;letter-spacing:0.05px;}
#t23_92{left:94px;bottom:268px;letter-spacing:0.05px;}
#t24_92{left:194px;bottom:267px;letter-spacing:0.08px;word-spacing:0.21px;}
#t25_92{left:262px;bottom:267px;}
#t26_92{left:269px;bottom:267px;}
#t27_92{left:273px;bottom:267px;letter-spacing:0.2px;}
#t28_92{left:292px;bottom:267px;letter-spacing:0.12px;}
#t29_92{left:348px;bottom:268px;letter-spacing:0.05px;}
#t2a_92{left:400px;bottom:267px;letter-spacing:0.14px;word-spacing:0.05px;}
#t2b_92{left:459px;bottom:268px;letter-spacing:0.05px;}
#t2c_92{left:550px;bottom:267px;letter-spacing:0.1px;}
#t2d_92{left:57px;bottom:249px;letter-spacing:0.11px;}
#t2e_92{left:132px;bottom:250px;letter-spacing:0.05px;}
#t2f_92{left:185px;bottom:249px;letter-spacing:0.09px;word-spacing:1.86px;}
#t2g_92{left:57px;bottom:231px;letter-spacing:0.09px;word-spacing:0.65px;}
#t2h_92{left:80px;bottom:212px;letter-spacing:0.1px;word-spacing:2.76px;}
#t2i_92{left:57px;bottom:194px;letter-spacing:0.07px;word-spacing:2.09px;}
#t2j_92{left:57px;bottom:176px;letter-spacing:0.1px;word-spacing:2.98px;}
#t2k_92{left:311px;bottom:176px;letter-spacing:0.07px;word-spacing:3.05px;}
#t2l_92{left:57px;bottom:158px;letter-spacing:0.07px;word-spacing:2.07px;}
#t2m_92{left:57px;bottom:139px;letter-spacing:0.08px;word-spacing:1.01px;}
#t2n_92{left:57px;bottom:121px;letter-spacing:0.09px;word-spacing:2.18px;}
#t2o_92{left:57px;bottom:103px;letter-spacing:0.07px;word-spacing:1.92px;}
#t2p_92{left:123px;bottom:104px;letter-spacing:0.05px;}
#t2q_92{left:176px;bottom:103px;letter-spacing:0.06px;word-spacing:1.95px;}
#t2r_92{left:390px;bottom:104px;letter-spacing:0.05px;}
#t2s_92{left:491px;bottom:103px;letter-spacing:0.02px;word-spacing:2.08px;}
#t2t_92{left:57px;bottom:85px;letter-spacing:0.07px;word-spacing:0.79px;}

.s0_92{font-size:15px;font-family:TeXPalladioL-ItalicOsF_amn;color:#000;}
.s1_92{font-size:15px;font-family:Palatino-Italic_amd;color:#000;}
.s2_92{font-size:15px;font-family:TeXPalladioL-SC_amc;color:#000;}
.s3_92{font-size:15px;font-family:Palatino-Roman_ame;color:#000;}
.s4_92{font-size:13px;font-family:LucidaSansTypewriter_amm;color:#000;}
.s5_92{font-size:18px;font-family:TeXPalladioL-BoldOsF_aml;color:#000;}
.s6_92{font-size:18px;font-family:Palatino-Bold_amf;color:#000;}
</style>
<!-- End inline CSS -->

<!-- Begin embedded font definitions -->
<style id="fonts92" type="text/css" >

@font-face {
	font-family: LucidaSansTypewriter_amm;
	src: url("fonts/LucidaSansTypewriter_amm.woff") format("woff");
}

@font-face {
	font-family: Palatino-Bold_amf;
	src: url("fonts/Palatino-Bold_amf.woff") format("woff");
}

@font-face {
	font-family: Palatino-Italic_amd;
	src: url("fonts/Palatino-Italic_amd.woff") format("woff");
}

@font-face {
	font-family: Palatino-Roman_ame;
	src: url("fonts/Palatino-Roman_ame.woff") format("woff");
}

@font-face {
	font-family: TeXPalladioL-BoldOsF_aml;
	src: url("fonts/TeXPalladioL-BoldOsF_aml.woff") format("woff");
}

@font-face {
	font-family: TeXPalladioL-ItalicOsF_amn;
	src: url("fonts/TeXPalladioL-ItalicOsF_amn.woff") format("woff");
}

@font-face {
	font-family: TeXPalladioL-SC_amc;
	src: url("fonts/TeXPalladioL-SC_amc.woff") format("woff");
}

</style>
<!-- End embedded font definitions -->

<!-- Begin page background -->
<div id="pg92Overlay" style="width:100%; height:100%; position:absolute; z-index:1; background-color:rgba(0,0,0,0); -webkit-user-select: none;"></div>
<div id="pg92" style="-webkit-user-select: none;"><object width="662" height="1017" data="92/92.svg" type="image/svg+xml" id="pdf92" style="width:662px; height:1017px; -moz-transform:scale(1); z-index: 0;"></object></div>
<!-- End page background -->


<!-- Begin text definitions (Positioned/styled in CSS) -->
<div class="text-container"><span id="t1_92" class="t s0_92">4</span><span id="t2_92" class="t s1_92">.</span><span id="t3_92" class="t s0_92">4</span><span id="t4_92" class="t s1_92">. Adding functionality to existing thread-safe classes </span><span id="t5_92" class="t s2_92">71 </span>
<span id="t6_92" class="t s3_92">vehicle locations or to take action when a location changes, the approach taken </span>
<span id="t7_92" class="t s3_92">by </span><span id="t8_92" class="t s4_92">PublishingVehicleTracker </span><span id="t9_92" class="t s3_92">would not be appropriate. </span>
<span id="ta_92" class="t s5_92">4</span><span id="tb_92" class="t s6_92">.</span><span id="tc_92" class="t s5_92">4 </span><span id="td_92" class="t s6_92">Adding functionality to existing thread-safe classes </span>
<span id="te_92" class="t s3_92">The Java class library contains many useful “building block” classes. </span><span id="tf_92" class="t s3_92">Reusing </span>
<span id="tg_92" class="t s3_92">existing classes is often preferable to creating new ones: reuse can reduce de- </span>
<span id="th_92" class="t s3_92">velopment effort, development risk (because the existing components are already </span>
<span id="ti_92" class="t s3_92">tested), and maintenance cost. Sometimes a thread-safe class that supports all of </span>
<span id="tj_92" class="t s3_92" data-mappings='[[65,"fi"]]'>the operations we want already exists, but often the best we can ﬁnd is a class </span>
<span id="tk_92" class="t s3_92">that supports </span><span id="tl_92" class="t s1_92">almost </span><span id="tm_92" class="t s3_92">all the operations we want, and then we need to add a new </span>
<span id="tn_92" class="t s3_92">operation to it without undermining its thread safety. </span>
<span id="to_92" class="t s3_92">As an example, let’s say we need a thread-safe </span><span id="tp_92" class="t s4_92">List </span><span id="tq_92" class="t s3_92">with an atomic put-if- </span>
<span id="tr_92" class="t s3_92">absent operation. </span><span id="ts_92" class="t s3_92">The synchronized </span><span id="tt_92" class="t s4_92">List </span><span id="tu_92" class="t s3_92">implementations nearly do the job, </span>
<span id="tv_92" class="t s3_92">since they provide the </span><span id="tw_92" class="t s4_92">contains </span><span id="tx_92" class="t s3_92">and </span><span id="ty_92" class="t s4_92">add </span><span id="tz_92" class="t s3_92">methods from which we can construct a </span>
<span id="t10_92" class="t s3_92">put-if-absent operation. </span>
<span id="t11_92" class="t s3_92">The concept of put-if-absent is straightforward enough—check to see if an </span>
<span id="t12_92" class="t s3_92">element is in the collection before adding it, and do not add it if it is already there. </span>
<span id="t13_92" class="t s3_92">(Your “check-then-act” warning bells should be going off now.) The requirement </span>
<span id="t14_92" class="t s3_92">that the class be thread-safe implicitly adds another requirement—that operations </span>
<span id="t15_92" class="t s3_92">like put-if-absent be </span><span id="t16_92" class="t s1_92">atomic</span><span id="t17_92" class="t s3_92">. Any reasonable interpretation suggests that, if you </span>
<span id="t18_92" class="t s3_92">take a </span><span id="t19_92" class="t s4_92">List </span><span id="t1a_92" class="t s3_92">that does not contain object </span><span id="t1b_92" class="t s1_92">X</span><span id="t1c_92" class="t s3_92">, and add </span><span id="t1d_92" class="t s1_92">X </span><span id="t1e_92" class="t s3_92">twice with put-if-absent, </span>
<span id="t1f_92" class="t s3_92">the resulting collection contains only one copy of </span><span id="t1g_92" class="t s1_92">X</span><span id="t1h_92" class="t s3_92">. </span><span id="t1i_92" class="t s3_92">But, if put-if-absent were </span>
<span id="t1j_92" class="t s3_92">not atomic, with some unlucky timing two threads could both see that </span><span id="t1k_92" class="t s1_92">X </span><span id="t1l_92" class="t s3_92">was not </span>
<span id="t1m_92" class="t s3_92">present and both add </span><span id="t1n_92" class="t s1_92">X</span><span id="t1o_92" class="t s3_92">, resulting in two copies of </span><span id="t1p_92" class="t s1_92">X</span><span id="t1q_92" class="t s3_92">. </span>
<span id="t1r_92" class="t s3_92">The safest way to add a new atomic operation is to modify the original class </span>
<span id="t1s_92" class="t s3_92">to support the desired operation, but this is not always possible because you may </span>
<span id="t1t_92" class="t s3_92">not have access to the source code or may not be free to modify it. </span><span id="t1u_92" class="t s3_92">If you can </span>
<span id="t1v_92" class="t s3_92">modify the original class, you need to understand the implementation’s synchro- </span>
<span id="t1w_92" class="t s3_92">nization policy so that you can enhance it in a manner consistent with its original </span>
<span id="t1x_92" class="t s3_92">design. </span><span id="t1y_92" class="t s3_92">Adding the new method directly to the class means that all the code </span>
<span id="t1z_92" class="t s3_92">that implements the synchronization policy for that class is still contained in one </span>
<span id="t20_92" class="t s3_92" data-mappings='[[7,"fi"]]'>source ﬁle, facilitating easier comprehension and maintenance. </span>
<span id="t21_92" class="t s3_92">Another approach is to extend the class, assuming it was designed for exten- </span>
<span id="t22_92" class="t s3_92">sion. </span><span id="t23_92" class="t s4_92">BetterVector </span><span id="t24_92" class="t s3_92">in Listing </span><span id="t25_92" class="t s2_92">4</span><span id="t26_92" class="t s3_92">.</span><span id="t27_92" class="t s2_92">13 </span><span id="t28_92" class="t s3_92">extends </span><span id="t29_92" class="t s4_92">Vector </span><span id="t2a_92" class="t s3_92">to add a </span><span id="t2b_92" class="t s4_92">putIfAbsent </span><span id="t2c_92" class="t s3_92">method. </span>
<span id="t2d_92" class="t s3_92">Extending </span><span id="t2e_92" class="t s4_92">Vector </span><span id="t2f_92" class="t s3_92">is straightforward enough, but not all classes expose enough </span>
<span id="t2g_92" class="t s3_92">of their state to subclasses to admit this approach. </span>
<span id="t2h_92" class="t s3_92">Extension is more fragile than adding code directly to a class, because the </span>
<span id="t2i_92" class="t s3_92">implementation of the synchronization policy is now distributed over multiple, </span>
<span id="t2j_92" class="t s3_92" data-mappings='[[29,"fi"]]'>separately maintained source ﬁles. </span><span id="t2k_92" class="t s3_92">If the underlying class were to change its </span>
<span id="t2l_92" class="t s3_92">synchronization policy by choosing a different lock to guard its state variables, </span>
<span id="t2m_92" class="t s3_92">the subclass would subtly and silently break, because it no longer used the right </span>
<span id="t2n_92" class="t s3_92">lock to control concurrent access to the base class’s state. (The synchronization </span>
<span id="t2o_92" class="t s3_92">policy of </span><span id="t2p_92" class="t s4_92">Vector </span><span id="t2q_92" class="t s3_92" data-mappings='[[3,"fi"],[20,"fi"]]'>is ﬁxed by its speciﬁcation, so </span><span id="t2r_92" class="t s4_92">BetterVector </span><span id="t2s_92" class="t s3_92">would not suffer </span>
<span id="t2t_92" class="t s3_92">from this problem.) </span></div>
<!-- End text definitions -->


</div>
</body>
</html>
