<!DOCTYPE html>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=Edge" />
<meta charset="utf-8" />
</head>

<body style="margin: 0;">

<div id="p321" style="overflow: hidden; position: relative; background-color: white; width: 662px; height: 1017px;">

<!-- Begin shared CSS values -->
<style class="shared-css" type="text/css" >
.t {
	transform-origin: bottom left;
	z-index: 2;
	position: absolute;
	white-space: pre;
	overflow: visible;
	line-height: 1.5;
}
.text-container {
	white-space: pre;
}
@supports (-webkit-touch-callout: none) {
	.text-container {
		white-space: normal;
	}
}
</style>
<!-- End shared CSS values -->


<!-- Begin inline CSS -->
<style type="text/css" >

#t1_321{left:57px;bottom:942px;letter-spacing:0.2px;}
#t2_321{left:326px;bottom:942px;letter-spacing:0.13px;}
#t3_321{left:379px;bottom:942px;letter-spacing:0.2px;}
#t4_321{left:395px;bottom:942px;letter-spacing:0.1px;word-spacing:2.12px;}
#t5_321{left:72px;bottom:882px;letter-spacing:-0.22px;word-spacing:1px;}
#t6_321{left:166px;bottom:882px;letter-spacing:-0.23px;}
#t7_321{left:206px;bottom:882px;letter-spacing:-0.22px;word-spacing:0.92px;}
#t8_321{left:483px;bottom:882px;letter-spacing:-0.23px;word-spacing:1.98px;}
#t9_321{left:72px;bottom:861px;letter-spacing:-0.23px;}
#ta_321{left:106px;bottom:861px;letter-spacing:-0.24px;word-spacing:3.26px;}
#tb_321{left:217px;bottom:861px;letter-spacing:-0.23px;}
#tc_321{left:258px;bottom:861px;letter-spacing:-0.26px;word-spacing:1.43px;}
#td_321{left:72px;bottom:841px;letter-spacing:-0.24px;word-spacing:2.13px;}
#te_321{left:72px;bottom:820px;letter-spacing:-0.25px;word-spacing:1.05px;}
#tf_321{left:72px;bottom:799px;letter-spacing:-0.23px;word-spacing:-0.13px;}
#tg_321{left:57px;bottom:727px;letter-spacing:-0.25px;}
#th_321{left:73px;bottom:727px;}
#ti_321{left:78px;bottom:727px;}
#tj_321{left:86px;bottom:727px;}
#tk_321{left:90px;bottom:727px;}
#tl_321{left:115px;bottom:727px;letter-spacing:-0.26px;word-spacing:0.81px;}
#tm_321{left:57px;bottom:700px;letter-spacing:0.08px;word-spacing:3.13px;}
#tn_321{left:57px;bottom:681px;letter-spacing:0.08px;word-spacing:2.71px;}
#to_321{left:453px;bottom:682px;letter-spacing:0.05px;}
#tp_321{left:491px;bottom:681px;letter-spacing:0.11px;word-spacing:2.45px;}
#tq_321{left:57px;bottom:663px;letter-spacing:0.09px;word-spacing:-0.23px;}
#tr_321{left:57px;bottom:645px;letter-spacing:0.11px;}
#ts_321{left:80px;bottom:627px;letter-spacing:0.09px;word-spacing:-0.57px;}
#tt_321{left:57px;bottom:608px;letter-spacing:0.07px;word-spacing:1.32px;}
#tu_321{left:445px;bottom:609px;letter-spacing:0.05px;}
#tv_321{left:516px;bottom:608px;letter-spacing:0.08px;word-spacing:1.74px;}
#tw_321{left:57px;bottom:590px;letter-spacing:0.1px;word-spacing:1.18px;}
#tx_321{left:293px;bottom:590px;letter-spacing:0.17px;}
#ty_321{left:321px;bottom:590px;letter-spacing:0.04px;word-spacing:1.47px;}
#tz_321{left:57px;bottom:572px;letter-spacing:0.06px;word-spacing:1.33px;}
#t10_321{left:57px;bottom:554px;letter-spacing:0.06px;word-spacing:1.86px;}
#t11_321{left:412px;bottom:561px;}
#t12_321{left:427px;bottom:554px;letter-spacing:-0.05px;}
#t13_321{left:521px;bottom:554px;letter-spacing:0.05px;}
#t14_321{left:559px;bottom:554px;letter-spacing:-0.08px;word-spacing:2.19px;}
#t15_321{left:57px;bottom:535px;letter-spacing:0.09px;word-spacing:0.61px;}
#t16_321{left:535px;bottom:536px;letter-spacing:0.05px;}
#t17_321{left:582px;bottom:535px;}
#t18_321{left:586px;bottom:543px;}
#t19_321{left:80px;bottom:517px;letter-spacing:0.1px;word-spacing:1.07px;}
#t1a_321{left:354px;bottom:518px;letter-spacing:0.05px;}
#t1b_321{left:386px;bottom:517px;letter-spacing:0.09px;word-spacing:1.09px;}
#t1c_321{left:57px;bottom:499px;letter-spacing:0.09px;word-spacing:1.62px;}
#t1d_321{left:57px;bottom:481px;letter-spacing:0.07px;word-spacing:0.28px;}
#t1e_321{left:462px;bottom:481px;letter-spacing:0.05px;}
#t1f_321{left:533px;bottom:481px;letter-spacing:0.09px;word-spacing:0.63px;}
#t1g_321{left:57px;bottom:462px;letter-spacing:0.03px;word-spacing:1.79px;}
#t1h_321{left:313px;bottom:462px;letter-spacing:0.17px;}
#t1i_321{left:342px;bottom:462px;letter-spacing:0.08px;word-spacing:2.35px;}
#t1j_321{left:57px;bottom:444px;letter-spacing:0.06px;word-spacing:0.93px;}
#t1k_321{left:57px;bottom:426px;letter-spacing:0.01px;word-spacing:1.07px;}
#t1l_321{left:233px;bottom:427px;letter-spacing:0.05px;}
#t1m_321{left:270px;bottom:426px;letter-spacing:0.08px;word-spacing:1.1px;}
#t1n_321{left:57px;bottom:407px;letter-spacing:0.06px;word-spacing:1.61px;}
#t1o_321{left:212px;bottom:408px;letter-spacing:0.05px;}
#t1p_321{left:243px;bottom:407px;letter-spacing:0.03px;word-spacing:2.19px;}
#t1q_321{left:559px;bottom:408px;letter-spacing:0.05px;}
#t1r_321{left:57px;bottom:389px;letter-spacing:0.04px;}
#t1s_321{left:76px;bottom:390px;letter-spacing:0.05px;}
#t1t_321{left:147px;bottom:389px;letter-spacing:0.04px;word-spacing:1.84px;}
#t1u_321{left:312px;bottom:389px;letter-spacing:0.12px;}
#t1v_321{left:364px;bottom:389px;letter-spacing:0.1px;word-spacing:1.42px;}
#t1w_321{left:57px;bottom:371px;letter-spacing:0.1px;word-spacing:2.49px;}
#t1x_321{left:57px;bottom:353px;letter-spacing:0.09px;word-spacing:1.1px;}
#t1y_321{left:287px;bottom:353px;letter-spacing:0.07px;}
#t1z_321{left:396px;bottom:353px;letter-spacing:0.08px;word-spacing:1.17px;}
#t20_321{left:57px;bottom:334px;letter-spacing:0.1px;word-spacing:0.65px;}
#t21_321{left:404px;bottom:342px;}
#t22_321{left:80px;bottom:316px;letter-spacing:0.04px;word-spacing:-0.22px;}
#t23_321{left:389px;bottom:317px;letter-spacing:0.05px;}
#t24_321{left:424px;bottom:316px;letter-spacing:0.04px;word-spacing:-0.2px;}
#t25_321{left:57px;bottom:298px;letter-spacing:0.13px;}
#t26_321{left:126px;bottom:298px;letter-spacing:0.13px;}
#t27_321{left:160px;bottom:298px;letter-spacing:0.06px;word-spacing:2.33px;}
#t28_321{left:540px;bottom:298px;letter-spacing:0.01px;word-spacing:2.48px;}
#t29_321{left:57px;bottom:280px;letter-spacing:0.08px;word-spacing:1.76px;}
#t2a_321{left:57px;bottom:261px;letter-spacing:0.05px;word-spacing:1.3px;}
#t2b_321{left:203px;bottom:262px;letter-spacing:0.05px;}
#t2c_321{left:240px;bottom:261px;letter-spacing:0.08px;word-spacing:1.45px;}
#t2d_321{left:57px;bottom:243px;letter-spacing:0.07px;word-spacing:0.83px;}
#t2e_321{left:565px;bottom:243px;letter-spacing:0.2px;}
#t2f_321{left:581px;bottom:243px;}
#t2g_321{left:584px;bottom:243px;}
#t2h_321{left:592px;bottom:243px;}
#t2i_321{left:57px;bottom:212px;}
#t2j_321{left:63px;bottom:212px;}
#t2k_321{left:74px;bottom:212px;letter-spacing:0.06px;word-spacing:1.39px;}
#t2l_321{left:57px;bottom:197px;word-spacing:2.61px;}
#t2m_321{left:57px;bottom:183px;letter-spacing:0.09px;word-spacing:0.44px;}
#t2n_321{left:57px;bottom:168px;}
#t2o_321{left:63px;bottom:168px;}
#t2p_321{left:74px;bottom:168px;letter-spacing:0.02px;word-spacing:0.58px;}
#t2q_321{left:57px;bottom:154px;letter-spacing:0.05px;word-spacing:0.54px;}
#t2r_321{left:57px;bottom:139px;}
#t2s_321{left:63px;bottom:139px;}
#t2t_321{left:74px;bottom:139px;letter-spacing:0.06px;word-spacing:1.5px;}
#t2u_321{left:57px;bottom:125px;letter-spacing:0.06px;word-spacing:0.61px;}

.s0_321{font-size:15px;font-family:TeXPalladioL-SC_amc;color:#000;}
.s1_321{font-size:15px;font-family:Palatino-Italic_amd;color:#000;}
.s2_321{font-size:15px;font-family:TeXPalladioL-ItalicOsF_amn;color:#000;}
.s3_321{font-size:15px;font-family:LucidaSans_amq;color:#000;}
.s4_321{font-size:15px;font-family:LucidaSansTypewriter_amm;color:#000;}
.s5_321{font-size:15px;font-family:LucidaSans-Italic_ams;color:#000;}
.s6_321{font-size:17px;font-family:TeXPalladioL-BoldOsF_aml;color:#000;}
.s7_321{font-size:17px;font-family:Palatino-Bold_amf;color:#000;}
.s8_321{font-size:15px;font-family:Palatino-Roman_ame;color:#000;}
.s9_321{font-size:13px;font-family:LucidaSansTypewriter_amm;color:#000;}
.sa_321{font-size:12px;font-family:TeXPalladioL-SC_amc;color:#000;}
.sb_321{font-size:12px;font-family:Palatino-Roman_ame;color:#000;}
</style>
<!-- End inline CSS -->

<!-- Begin embedded font definitions -->
<style id="fonts321" type="text/css" >

@font-face {
	font-family: LucidaSans-Italic_ams;
	src: url("fonts/LucidaSans-Italic_ams.woff") format("woff");
}

@font-face {
	font-family: LucidaSansTypewriter_amm;
	src: url("fonts/LucidaSansTypewriter_amm.woff") format("woff");
}

@font-face {
	font-family: LucidaSans_amq;
	src: url("fonts/LucidaSans_amq.woff") format("woff");
}

@font-face {
	font-family: Palatino-Bold_amf;
	src: url("fonts/Palatino-Bold_amf.woff") format("woff");
}

@font-face {
	font-family: Palatino-Italic_amd;
	src: url("fonts/Palatino-Italic_amd.woff") format("woff");
}

@font-face {
	font-family: Palatino-Roman_ame;
	src: url("fonts/Palatino-Roman_ame.woff") format("woff");
}

@font-face {
	font-family: TeXPalladioL-BoldOsF_aml;
	src: url("fonts/TeXPalladioL-BoldOsF_aml.woff") format("woff");
}

@font-face {
	font-family: TeXPalladioL-ItalicOsF_amn;
	src: url("fonts/TeXPalladioL-ItalicOsF_amn.woff") format("woff");
}

@font-face {
	font-family: TeXPalladioL-SC_amc;
	src: url("fonts/TeXPalladioL-SC_amc.woff") format("woff");
}

</style>
<!-- End embedded font definitions -->

<!-- Begin page background -->
<div id="pg321Overlay" style="width:100%; height:100%; position:absolute; z-index:1; background-color:rgba(0,0,0,0); -webkit-user-select: none;"></div>
<div id="pg321" style="-webkit-user-select: none;"><object width="662" height="1017" data="321/321.svg" type="image/svg+xml" id="pdf321" style="width:662px; height:1017px; -moz-transform:scale(1); z-index: 0;"></object></div>
<!-- End page background -->


<!-- Begin text definitions (Positioned/styled in CSS) -->
<div class="text-container"><span id="t1_321" class="t s0_321">300 </span><span id="t2_321" class="t s1_321">Chapter </span><span id="t3_321" class="t s2_321">14</span><span id="t4_321" class="t s1_321">. Building Custom Synchronizers </span>
<span id="t5_321" class="t s3_321">Every call to </span><span id="t6_321" class="t s4_321">wait </span><span id="t7_321" class="t s3_321" data-mappings='[[37,"fi"]]'>is implicitly associated with a speciﬁc </span><span id="t8_321" class="t s5_321">condition pred- </span>
<span id="t9_321" class="t s5_321">icate</span><span id="ta_321" class="t s3_321">. When calling </span><span id="tb_321" class="t s4_321">wait </span><span id="tc_321" class="t s3_321">regarding a particular condition predicate, the </span>
<span id="td_321" class="t s3_321">caller must already hold the lock associated with the condition queue, </span>
<span id="te_321" class="t s3_321">and that lock must also guard the state variables from which the condi- </span>
<span id="tf_321" class="t s3_321">tion predicate is composed. </span>
<span id="tg_321" class="t s6_321">14</span><span id="th_321" class="t s7_321">.</span><span id="ti_321" class="t s6_321">2</span><span id="tj_321" class="t s7_321">.</span><span id="tk_321" class="t s6_321">2 </span><span id="tl_321" class="t s7_321">Waking up too soon </span>
<span id="tm_321" class="t s8_321">As if the three-way relationship among the lock, the condition predicate, and </span>
<span id="tn_321" class="t s8_321">the condition queue were not complicated enough, that </span><span id="to_321" class="t s9_321">wait </span><span id="tp_321" class="t s8_321">returns does not </span>
<span id="tq_321" class="t s8_321">necessarily mean that the condition predicate the thread is waiting for has become </span>
<span id="tr_321" class="t s8_321">true. </span>
<span id="ts_321" class="t s1_321">A single intrinsic condition queue may be used with more than one condition predicate. </span>
<span id="tt_321" class="t s8_321">When your thread is awakened because someone called </span><span id="tu_321" class="t s9_321">notifyAll</span><span id="tv_321" class="t s8_321">, that doesn’t </span>
<span id="tw_321" class="t s8_321">mean that the condition predicate </span><span id="tx_321" class="t s1_321">you </span><span id="ty_321" class="t s8_321">were waiting for is now true. (This is like </span>
<span id="tz_321" class="t s8_321">having your toaster and coffee maker share a single bell; when it rings, you still </span>
<span id="t10_321" class="t s8_321">have to look to see which device raised the signal.) </span>
<span id="t11_321" class="t sa_321">7 </span>
<span id="t12_321" class="t s8_321">Additionally, </span><span id="t13_321" class="t s9_321">wait </span><span id="t14_321" class="t s8_321">is even </span>
<span id="t15_321" class="t s8_321">allowed to return “spuriously”—not in response to any thread calling </span><span id="t16_321" class="t s9_321">notify</span><span id="t17_321" class="t s8_321">. </span>
<span id="t18_321" class="t sa_321">8 </span>
<span id="t19_321" class="t s8_321">When control re-enters the code calling </span><span id="t1a_321" class="t s9_321">wait</span><span id="t1b_321" class="t s8_321">, it has reacquired the lock asso- </span>
<span id="t1c_321" class="t s8_321">ciated with the condition queue. Is the condition predicate now true? Maybe. It </span>
<span id="t1d_321" class="t s8_321">might have been true at the time the notifying thread called </span><span id="t1e_321" class="t s9_321">notifyAll</span><span id="t1f_321" class="t s8_321">, but could </span>
<span id="t1g_321" class="t s8_321">have become false again by the time </span><span id="t1h_321" class="t s1_321">you </span><span id="t1i_321" class="t s8_321">reacquire the lock. Other threads may </span>
<span id="t1j_321" class="t s8_321">have acquired the lock and changed the object’s state between when your thread </span>
<span id="t1k_321" class="t s8_321">was awakened and when </span><span id="t1l_321" class="t s9_321">wait </span><span id="t1m_321" class="t s8_321">reacquired the lock. Or maybe it hasn’t been true </span>
<span id="t1n_321" class="t s8_321">at all since you called </span><span id="t1o_321" class="t s9_321">wait</span><span id="t1p_321" class="t s8_321">. You don’t know why another thread called </span><span id="t1q_321" class="t s9_321">notify </span>
<span id="t1r_321" class="t s8_321">or </span><span id="t1s_321" class="t s9_321">notifyAll</span><span id="t1t_321" class="t s8_321">; maybe it was because </span><span id="t1u_321" class="t s1_321">another </span><span id="t1v_321" class="t s8_321">condition predicate associated with </span>
<span id="t1w_321" class="t s8_321">the same condition queue became true. Multiple condition predicates per con- </span>
<span id="t1x_321" class="t s8_321">dition queue are quite common—</span><span id="t1y_321" class="t s9_321">BoundedBuffer </span><span id="t1z_321" class="t s8_321">uses the same condition queue </span>
<span id="t20_321" class="t s8_321">for both the “not full” and “not empty” predicates. </span>
<span id="t21_321" class="t sa_321">9 </span>
<span id="t22_321" class="t s8_321">For all these reasons, when you wake up from </span><span id="t23_321" class="t s9_321">wait </span><span id="t24_321" class="t s8_321">you must test the condition </span>
<span id="t25_321" class="t s8_321">predicate </span><span id="t26_321" class="t s1_321">again</span><span id="t27_321" class="t s8_321">, and go back to waiting (or fail) if it is not yet true. </span><span id="t28_321" class="t s8_321">Since you </span>
<span id="t29_321" class="t s8_321">can wake up repeatedly without your condition predicate being true, you must </span>
<span id="t2a_321" class="t s8_321">therefore always call </span><span id="t2b_321" class="t s9_321">wait </span><span id="t2c_321" class="t s8_321">from within a loop, testing the condition predicate in </span>
<span id="t2d_321" class="t s8_321">each iteration. The canonical form for a condition wait is shown in Listing </span><span id="t2e_321" class="t s0_321">14</span><span id="t2f_321" class="t s8_321">.</span><span id="t2g_321" class="t s0_321">7</span><span id="t2h_321" class="t s8_321">. </span>
<span id="t2i_321" class="t sa_321">7</span><span id="t2j_321" class="t sb_321">. </span><span id="t2k_321" class="t sb_321">This situation actually describes Tim’s kitchen pretty well; so many devices beep that when you </span>
<span id="t2l_321" class="t sb_321">hear one, you have to inspect the toaster, the microwave, the coffee maker, and several others to </span>
<span id="t2m_321" class="t sb_321">determine the cause of the signal. </span>
<span id="t2n_321" class="t sa_321">8</span><span id="t2o_321" class="t sb_321">. </span><span id="t2p_321" class="t sb_321">To push the breakfast analogy way too far, this is like a toaster with a loose connection that makes </span>
<span id="t2q_321" class="t sb_321">the bell go off when the toast is ready but also sometimes when it is not ready. </span>
<span id="t2r_321" class="t sa_321">9</span><span id="t2s_321" class="t sb_321">. </span><span id="t2t_321" class="t sb_321">It is actually possible for threads to be waiting for both “not full” and “not empty” at the same </span>
<span id="t2u_321" class="t sb_321">time! This can happen when the number of producers/consumers exceeds the buffer capacity. </span></div>
<!-- End text definitions -->


</div>
</body>
</html>
