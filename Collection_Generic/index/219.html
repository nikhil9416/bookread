<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=Edge" />
<meta charset="utf-8" />
</head>

<body style="margin: 0;">

<div id="p219" style="overflow: hidden; position: relative; background-color: white; width: 770px; height: 1010px;">

<!-- Begin shared CSS values -->
<style class="shared-css" type="text/css" >
.t {
	transform-origin: bottom left;
	z-index: 2;
	position: absolute;
	white-space: pre;
	overflow: visible;
	line-height: 1.5;
}
.text-container {
	white-space: pre;
}
@supports (-webkit-touch-callout: none) {
	.text-container {
		white-space: normal;
	}
}
</style>
<!-- End shared CSS values -->


<!-- Begin inline CSS -->
<style type="text/css" >

#t1_219{left:110px;bottom:906px;letter-spacing:-0.18px;word-spacing:0.48px;}
#t2_219{left:110px;bottom:887px;letter-spacing:-0.17px;word-spacing:-0.24px;}
#t3_219{left:359px;bottom:887px;letter-spacing:-0.17px;word-spacing:-0.28px;}
#t4_219{left:545px;bottom:887px;letter-spacing:-0.17px;word-spacing:-0.28px;}
#t5_219{left:110px;bottom:869px;letter-spacing:-0.18px;}
#t6_219{left:110px;bottom:842px;letter-spacing:-0.18px;word-spacing:0.47px;}
#t7_219{left:110px;bottom:824px;letter-spacing:-0.18px;word-spacing:0.19px;}
#t8_219{left:110px;bottom:805px;letter-spacing:-0.17px;word-spacing:0.86px;}
#t9_219{left:110px;bottom:786px;letter-spacing:-0.17px;word-spacing:-0.72px;}
#ta_219{left:110px;bottom:767px;letter-spacing:-0.17px;}
#tb_219{left:110px;bottom:749px;letter-spacing:-0.17px;word-spacing:-1px;}
#tc_219{left:110px;bottom:730px;letter-spacing:-0.17px;word-spacing:-0.37px;}
#td_219{left:410px;bottom:731px;letter-spacing:0.01px;}
#te_219{left:557px;bottom:730px;letter-spacing:-0.17px;word-spacing:-0.37px;}
#tf_219{left:110px;bottom:711px;letter-spacing:-0.18px;}
#tg_219{left:221px;bottom:712px;letter-spacing:0.01px;}
#th_219{left:270px;bottom:711px;letter-spacing:-0.15px;}
#ti_219{left:337px;bottom:712px;letter-spacing:0.01px;}
#tj_219{left:432px;bottom:711px;letter-spacing:-0.16px;}
#tk_219{left:110px;bottom:685px;letter-spacing:-0.18px;word-spacing:-0.83px;}
#tl_219{left:110px;bottom:666px;letter-spacing:-0.17px;word-spacing:-0.61px;}
#tm_219{left:522px;bottom:667px;letter-spacing:0.01px;}
#tn_219{left:581px;bottom:666px;letter-spacing:-0.19px;word-spacing:-0.61px;}
#to_219{left:110px;bottom:648px;letter-spacing:-0.17px;word-spacing:-0.37px;}
#tp_219{left:110px;bottom:629px;letter-spacing:-0.15px;word-spacing:-0.9px;}
#tq_219{left:361px;bottom:630px;letter-spacing:0.01px;}
#tr_219{left:420px;bottom:629px;letter-spacing:-0.17px;word-spacing:-0.9px;}
#ts_219{left:564px;bottom:630px;letter-spacing:0.01px;}
#tt_219{left:613px;bottom:629px;letter-spacing:-0.18px;word-spacing:-0.9px;}
#tu_219{left:110px;bottom:610px;letter-spacing:-0.18px;word-spacing:1.5px;}
#tv_219{left:110px;bottom:592px;letter-spacing:-0.18px;word-spacing:-0.44px;}
#tw_219{left:282px;bottom:592px;letter-spacing:0.01px;}
#tx_219{left:313px;bottom:592px;letter-spacing:-0.17px;word-spacing:-0.44px;}
#ty_219{left:448px;bottom:592px;letter-spacing:0.01px;}
#tz_219{left:479px;bottom:592px;letter-spacing:-0.16px;word-spacing:-0.44px;}
#t10_219{left:110px;bottom:573px;letter-spacing:-0.17px;word-spacing:0.92px;}
#t11_219{left:578px;bottom:574px;letter-spacing:0.01px;}
#t12_219{left:632px;bottom:573px;letter-spacing:-0.15px;}
#t13_219{left:110px;bottom:554px;letter-spacing:-0.16px;word-spacing:-1.08px;}
#t14_219{left:110px;bottom:535px;letter-spacing:-0.18px;word-spacing:1.43px;}
#t15_219{left:413px;bottom:536px;letter-spacing:0.01px;}
#t16_219{left:474px;bottom:535px;letter-spacing:-0.19px;word-spacing:1.43px;}
#t17_219{left:110px;bottom:517px;letter-spacing:-0.17px;}
#t18_219{left:110px;bottom:490px;letter-spacing:-0.16px;word-spacing:0.27px;}
#t19_219{left:340px;bottom:490px;letter-spacing:-0.2px;}
#t1a_219{left:408px;bottom:490px;letter-spacing:-0.18px;word-spacing:0.36px;}
#t1b_219{left:110px;bottom:472px;letter-spacing:-0.17px;}
#t1c_219{left:217px;bottom:472px;letter-spacing:-0.18px;}
#t1d_219{left:264px;bottom:472px;letter-spacing:-0.17px;}
#t1e_219{left:110px;bottom:453px;letter-spacing:-0.18px;word-spacing:-1.13px;}
#t1f_219{left:110px;bottom:434px;letter-spacing:-0.16px;word-spacing:-1.18px;}
#t1g_219{left:110px;bottom:416px;letter-spacing:-0.17px;word-spacing:0.48px;}
#t1h_219{left:110px;bottom:397px;letter-spacing:-0.17px;word-spacing:0.14px;}
#t1i_219{left:110px;bottom:378px;letter-spacing:-0.17px;word-spacing:-0.95px;}
#t1j_219{left:110px;bottom:359px;letter-spacing:-0.17px;}
#t1k_219{left:110px;bottom:333px;letter-spacing:-0.18px;word-spacing:0.33px;}
#t1l_219{left:110px;bottom:314px;letter-spacing:-0.17px;word-spacing:-1.37px;}
#t1m_219{left:110px;bottom:296px;letter-spacing:-0.18px;word-spacing:0.58px;}
#t1n_219{left:110px;bottom:277px;letter-spacing:-0.17px;word-spacing:0.12px;}
#t1o_219{left:110px;bottom:258px;letter-spacing:-0.17px;word-spacing:-0.36px;}
#t1p_219{left:110px;bottom:240px;letter-spacing:-0.19px;}
#t1q_219{left:163px;bottom:240px;letter-spacing:0.01px;}
#t1r_219{left:215px;bottom:240px;letter-spacing:-0.17px;word-spacing:-1.11px;}
#t1s_219{left:110px;bottom:221px;letter-spacing:-0.17px;word-spacing:2.09px;}
#t1t_219{left:253px;bottom:222px;letter-spacing:0.01px;}
#t1u_219{left:289px;bottom:221px;letter-spacing:-0.18px;word-spacing:2.09px;}
#t1v_219{left:110px;bottom:202px;letter-spacing:-0.19px;}
#t1w_219{left:164px;bottom:203px;letter-spacing:0.01px;}
#t1x_219{left:234px;bottom:202px;letter-spacing:-0.18px;word-spacing:0.19px;}
#t1y_219{left:110px;bottom:184px;letter-spacing:-0.19px;}
#t1z_219{left:162px;bottom:184px;letter-spacing:0.01px;}
#t20_219{left:212px;bottom:184px;}
#t21_219{left:218px;bottom:184px;letter-spacing:0.01px;}
#t22_219{left:291px;bottom:184px;letter-spacing:-0.15px;}
#t23_219{left:339px;bottom:184px;letter-spacing:0.01px;}
#t24_219{left:377px;bottom:184px;letter-spacing:-0.16px;word-spacing:-1.39px;}
#t25_219{left:110px;bottom:165px;letter-spacing:-0.18px;word-spacing:1.17px;}
#t26_219{left:110px;bottom:146px;letter-spacing:-0.17px;word-spacing:-1.32px;}
#t27_219{left:110px;bottom:127px;letter-spacing:-0.18px;}
#t28_219{left:530px;bottom:60px;letter-spacing:-0.07px;}
#t29_219{left:554px;bottom:60px;letter-spacing:-0.1px;}
#t2a_219{left:631px;bottom:60px;}
#t2b_219{left:643px;bottom:60px;letter-spacing:-0.1px;}

.s1_219{font-size:16px;font-family:CNCSGY-2bBirka_1c;color:#000;}
.s2_219{font-size:16px;font-family:CNCSGY-2bBirka-Italic_1i;color:#000;}
.s3_219{font-size:14px;font-family:CNCSGY-2bTheSansMonoCd-W5Reg_dv;color:#000;}
.s4_219{font-size:14px;font-family:CNCSGY-2bMyriadPro-SemiboldCo_q;color:#000;}
</style>
<!-- End inline CSS -->

<!-- Begin embedded font definitions -->
<style id="fonts219" type="text/css" >

@font-face {
	font-family: CNCSGY-2bBirka-Italic_1i;
	src: url("fonts/CNCSGY-2bBirka-Italic_1i.woff") format("woff");
}

@font-face {
	font-family: CNCSGY-2bBirka_1c;
	src: url("fonts/CNCSGY-2bBirka_1c.woff") format("woff");
}

@font-face {
	font-family: CNCSGY-2bMyriadPro-SemiboldCo_q;
	src: url("fonts/CNCSGY-2bMyriadPro-SemiboldCo_q.woff") format("woff");
}

@font-face {
	font-family: CNCSGY-2bTheSansMonoCd-W5Reg_dv;
	src: url("fonts/CNCSGY-2bTheSansMonoCd-W5Reg_dv.woff") format("woff");
}

</style>
<!-- End embedded font definitions -->

<!-- Begin page background -->
<div id="pg219Overlay" style="width:100%; height:100%; position:absolute; z-index:1; background-color:rgba(0,0,0,0); -webkit-user-select: none;"></div>
<div id="pg219" style="-webkit-user-select: none;"><object width="770" height="1010" data="219/219.svg" type="image/svg+xml" id="pdf219" style="width:770px; height:1010px; -moz-transform:scale(1); z-index: 0;"></object></div>
<!-- End page background -->


<!-- Begin text definitions (Positioned/styled in CSS) -->
<div class="text-container"><span id="t1_219" class="t s1_219">information. Achieving graceful shutdown can often be a problem in concurrent sys- </span>
<span id="t2_219" class="t s1_219">tems: for more detail, see Chapter 7 of </span><span id="t3_219" class="t s2_219">Java Concurrency in Practice </span><span id="t4_219" class="t s1_219">by Brian Goetz et. </span>
<span id="t5_219" class="t s1_219">al. (Addison-Wesley). </span>
<span id="t6_219" class="t s1_219">The larger system will model each day’s scheduled tasks over the next year, allowing </span>
<span id="t7_219" class="t s1_219">consumers to process tasks from each day’s queue. An implicit assumption of the ex- </span>
<span id="t8_219" class="t s1_219">ample of this section is that if there are no remaining tasks scheduled for this day, a </span>
<span id="t9_219" class="t s1_219">consumer will not wait for one to become available, but will immediately go on to look </span>
<span id="ta_219" class="t s1_219">for a task in the next day’s queue. (In the real world, we would go home at this point, </span>
<span id="tb_219" class="t s1_219">or more likely go out to celebrate.) This assumption simplifies the example, as we don’t </span>
<span id="tc_219" class="t s1_219">need to invoke any of the blocking methods of </span><span id="td_219" class="t s3_219">PriorityBlockingQueue</span><span id="te_219" class="t s1_219">, though we will </span>
<span id="tf_219" class="t s1_219">use one method, </span><span id="tg_219" class="t s3_219">drainTo</span><span id="th_219" class="t s1_219">, from the </span><span id="ti_219" class="t s3_219">BlockingQueue </span><span id="tj_219" class="t s1_219">interface. </span>
<span id="tk_219" class="t s1_219">There are a number of ways of shutting down a producer-consumer queue such as this; </span>
<span id="tl_219" class="t s1_219">in the one we’ve chosen for this example, the manager exposes a </span><span id="tm_219" class="t s3_219">shutdown </span><span id="tn_219" class="t s1_219">method that </span>
<span id="to_219" class="t s1_219">can be called by a “supervisor” thread in order to stop producers writing to the queue, </span>
<span id="tp_219" class="t s1_219">to drain it, and to return the result. The </span><span id="tq_219" class="t s3_219">shutdown </span><span id="tr_219" class="t s1_219">method sets a boolean </span><span id="ts_219" class="t s3_219">stopped</span><span id="tt_219" class="t s1_219">, which </span>
<span id="tu_219" class="t s1_219">task-producing threads will read before trying to put a task on to the queue. Task- </span>
<span id="tv_219" class="t s1_219">consuming threads simply </span><span id="tw_219" class="t s3_219">poll </span><span id="tx_219" class="t s1_219">the queue, returning </span><span id="ty_219" class="t s3_219">null </span><span id="tz_219" class="t s1_219">if no tasks are available. The </span>
<span id="t10_219" class="t s1_219">problem with this simple idea is that a producer thread might read the </span><span id="t11_219" class="t s3_219">stopped </span><span id="t12_219" class="t s1_219">flag, </span>
<span id="t13_219" class="t s1_219">find it false, but then be suspended for some time before it places its value on the queue. </span>
<span id="t14_219" class="t s1_219">We have to prevent this by ensuring that the </span><span id="t15_219" class="t s3_219">shutdown </span><span id="t16_219" class="t s1_219">method, having stopped the </span>
<span id="t17_219" class="t s1_219">queue, will wait until all the pending values have been inserted before draining it. </span>
<span id="t18_219" class="t s1_219">Example 14-1 achieves this using a </span><span id="t19_219" class="t s2_219">semaphore</span><span id="t1a_219" class="t s1_219">—a thread-safe object that maintains a </span>
<span id="t1b_219" class="t s1_219">fixed number of </span><span id="t1c_219" class="t s2_219">permits</span><span id="t1d_219" class="t s1_219">. Semaphores are usually used to regulate access to a finite set </span>
<span id="t1e_219" class="t s1_219">of resources—a pool of database connections, for example. The permits the semaphore </span>
<span id="t1f_219" class="t s1_219">has available at any time represent the resources not currently in use. A thread requiring </span>
<span id="t1g_219" class="t s1_219">a resource acquires a permit from the semaphore, and releases it when it releases the </span>
<span id="t1h_219" class="t s1_219">resource. If all the resources are in use, the semaphore will have no permits available; </span>
<span id="t1i_219" class="t s1_219">at that point, a thread attempting to acquire a permit will block until some other thread </span>
<span id="t1j_219" class="t s1_219">returns one. </span>
<span id="t1k_219" class="t s1_219">The semaphore in this example is used differently.We don’twant to restrict producer </span>
<span id="t1l_219" class="t s1_219">threads from writing to the queue—it’s an unbounded concurrent queue, after all, quite </span>
<span id="t1m_219" class="t s1_219">capable of handling concurrent access without help from us. We just want to keep a </span>
<span id="t1n_219" class="t s1_219">count of the writes currently in progress. So we create the semaphore with the largest </span>
<span id="t1o_219" class="t s1_219">possible number of permits, which in practice will never all be required. The producer </span>
<span id="t1p_219" class="t s1_219">method </span><span id="t1q_219" class="t s3_219">addTask </span><span id="t1r_219" class="t s1_219">checks to see if the queue has been stopped—in which case its contract </span>
<span id="t1s_219" class="t s1_219">says it should return </span><span id="t1t_219" class="t s3_219">false</span><span id="t1u_219" class="t s1_219">—and, if not, it acquires a permit using the semaphore </span>
<span id="t1v_219" class="t s1_219">method </span><span id="t1w_219" class="t s3_219">tryAcquire</span><span id="t1x_219" class="t s1_219">, which does not block (unlike the more commonly used blocking </span>
<span id="t1y_219" class="t s1_219">method </span><span id="t1z_219" class="t s3_219">acquire</span><span id="t20_219" class="t s1_219">, </span><span id="t21_219" class="t s3_219">tryAcquire </span><span id="t22_219" class="t s1_219">returns </span><span id="t23_219" class="t s3_219">false </span><span id="t24_219" class="t s1_219">immediately if no permits are available). This </span>
<span id="t25_219" class="t s1_219">test-then-act sequence is made atomic to ensure that at any point visible to another </span>
<span id="t26_219" class="t s1_219">thread the program maintains its invariant: the number of unwritten values is no greater </span>
<span id="t27_219" class="t s1_219">than the number of permits available. </span>
<span id="t28_219" class="t s4_219">14.3 </span><span id="t29_219" class="t s4_219">BlockingQueue </span><span id="t2a_219" class="t s4_219">| </span><span id="t2b_219" class="t s4_219">201 </span></div>
<!-- End text definitions -->


</div>
</body>
</html>
