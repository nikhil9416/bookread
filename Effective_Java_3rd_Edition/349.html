<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=Edge" />
<meta charset="utf-8" />
</head>

<body style="margin: 0;">

<div id="p349" style="overflow: hidden; position: relative; background-color: white; width: 809px; height: 1017px;">

<!-- Begin shared CSS values -->
<style class="shared-css" type="text/css" >
.t {
	transform-origin: bottom left;
	z-index: 2;
	position: absolute;
	white-space: pre;
	overflow: visible;
	line-height: 1.5;
}
.text-container {
	white-space: pre;
}
@supports (-webkit-touch-callout: none) {
	.text-container {
		white-space: normal;
	}
}
</style>
<!-- End shared CSS values -->


<!-- Begin inline CSS -->
<style type="text/css" >

#t1_349{left:109px;bottom:955px;letter-spacing:0.12px;word-spacing:0.03px;}
#t2_349{left:190px;bottom:955px;letter-spacing:0.14px;}
#t3_349{left:59px;bottom:952px;letter-spacing:0.11px;}
#t4_349{left:137px;bottom:902px;letter-spacing:-0.11px;word-spacing:-0.05px;}
#t5_349{left:535px;bottom:903px;letter-spacing:-0.18px;}
#t6_349{left:572px;bottom:902px;letter-spacing:-0.12px;word-spacing:-0.06px;}
#t7_349{left:109px;bottom:881px;letter-spacing:-0.11px;word-spacing:-0.26px;}
#t8_349{left:109px;bottom:859px;letter-spacing:-0.12px;word-spacing:4.04px;}
#t9_349{left:471px;bottom:859px;letter-spacing:-0.14px;word-spacing:4.05px;}
#ta_349{left:109px;bottom:838px;letter-spacing:-0.1px;word-spacing:5.57px;}
#tb_349{left:471px;bottom:839px;letter-spacing:-0.16px;}
#tc_349{left:636px;bottom:838px;letter-spacing:-0.11px;word-spacing:5.64px;}
#td_349{left:109px;bottom:816px;letter-spacing:-0.09px;word-spacing:1.95px;}
#te_349{left:378px;bottom:818px;letter-spacing:-0.16px;}
#tf_349{left:109px;bottom:795px;letter-spacing:-0.08px;word-spacing:-0.56px;}
#tg_349{left:243px;bottom:796px;letter-spacing:-0.18px;}
#th_349{left:272px;bottom:795px;letter-spacing:-0.1px;word-spacing:-0.53px;}
#ti_349{left:109px;bottom:774px;letter-spacing:-0.09px;word-spacing:-0.01px;}
#tj_349{left:262px;bottom:775px;letter-spacing:-0.16px;}
#tk_349{left:390px;bottom:774px;letter-spacing:-0.15px;word-spacing:0.03px;}
#tl_349{left:574px;bottom:774px;letter-spacing:-0.16px;}
#tm_349{left:109px;bottom:752px;letter-spacing:-0.09px;word-spacing:-0.44px;}
#tn_349{left:243px;bottom:754px;letter-spacing:-0.16px;}
#to_349{left:371px;bottom:752px;letter-spacing:-0.09px;word-spacing:-0.44px;}
#tp_349{left:457px;bottom:754px;letter-spacing:-0.16px;}
#tq_349{left:655px;bottom:752px;}
#tr_349{left:109px;bottom:732px;letter-spacing:-0.16px;}
#ts_349{left:239px;bottom:731px;letter-spacing:-0.1px;word-spacing:1.79px;}
#tt_349{left:109px;bottom:710px;letter-spacing:-0.12px;word-spacing:2.72px;}
#tu_349{left:109px;bottom:688px;letter-spacing:-0.11px;word-spacing:0.78px;}
#tv_349{left:416px;bottom:690px;letter-spacing:-0.16px;}
#tw_349{left:470px;bottom:688px;letter-spacing:-0.1px;word-spacing:0.7px;}
#tx_349{left:109px;bottom:667px;letter-spacing:-0.09px;word-spacing:-0.43px;}
#ty_349{left:109px;bottom:645px;letter-spacing:-0.1px;word-spacing:-0.01px;}
#tz_349{left:137px;bottom:624px;letter-spacing:-0.1px;word-spacing:0.28px;}
#t10_349{left:109px;bottom:603px;letter-spacing:-0.11px;word-spacing:0.55px;}
#t11_349{left:109px;bottom:581px;letter-spacing:-0.09px;word-spacing:1.8px;}
#t12_349{left:276px;bottom:583px;letter-spacing:-0.16px;}
#t13_349{left:390px;bottom:581px;letter-spacing:-0.04px;}
#t14_349{left:410px;bottom:583px;letter-spacing:-0.16px;}
#t15_349{left:465px;bottom:581px;letter-spacing:-0.08px;word-spacing:1.78px;}
#t16_349{left:109px;bottom:560px;letter-spacing:-0.11px;}
#t17_349{left:137px;bottom:538px;letter-spacing:-0.1px;word-spacing:1.2px;}
#t18_349{left:626px;bottom:540px;letter-spacing:-0.15px;}
#t19_349{left:109px;bottom:517px;letter-spacing:-0.1px;}
#t1a_349{left:139px;bottom:518px;letter-spacing:-0.16px;}
#t1b_349{left:187px;bottom:517px;letter-spacing:-0.11px;word-spacing:0.96px;}
#t1c_349{left:539px;bottom:518px;letter-spacing:-0.18px;}
#t1d_349{left:577px;bottom:517px;letter-spacing:-0.08px;}
#t1e_349{left:606px;bottom:518px;letter-spacing:-0.16px;}
#t1f_349{left:655px;bottom:517px;}
#t1g_349{left:109px;bottom:496px;letter-spacing:-0.13px;}
#t1h_349{left:142px;bottom:497px;letter-spacing:-0.18px;}
#t1i_349{left:181px;bottom:496px;letter-spacing:-0.1px;word-spacing:1.76px;}
#t1j_349{left:109px;bottom:474px;letter-spacing:-0.12px;word-spacing:0.43px;}
#t1k_349{left:109px;bottom:453px;letter-spacing:-0.08px;word-spacing:-0.03px;}
#t1l_349{left:380px;bottom:454px;letter-spacing:-0.18px;}
#t1m_349{left:417px;bottom:453px;letter-spacing:-0.1px;}
#t1n_349{left:137px;bottom:420px;letter-spacing:-0.25px;word-spacing:0.02px;}
#t1o_349{left:137px;bottom:403px;letter-spacing:-0.25px;word-spacing:0.03px;}
#t1p_349{left:169px;bottom:386px;letter-spacing:-0.25px;}
#t1q_349{left:202px;bottom:369px;letter-spacing:-0.24px;word-spacing:-0.2px;}
#t1r_349{left:169px;bottom:353px;letter-spacing:-0.25px;word-spacing:0.04px;}
#t1s_349{left:137px;bottom:336px;}
#t1t_349{left:109px;bottom:300px;letter-spacing:-0.12px;word-spacing:1.79px;}
#t1u_349{left:446px;bottom:301px;letter-spacing:-0.15px;}
#t1v_349{left:485px;bottom:300px;letter-spacing:-0.18px;word-spacing:1.84px;}
#t1w_349{left:109px;bottom:279px;letter-spacing:-0.08px;word-spacing:-0.02px;}
#t1x_349{left:235px;bottom:279px;letter-spacing:-0.09px;word-spacing:0.03px;}
#t1y_349{left:137px;bottom:257px;letter-spacing:-0.12px;word-spacing:2.28px;}
#t1z_349{left:109px;bottom:236px;letter-spacing:-0.1px;word-spacing:0.71px;}
#t20_349{left:109px;bottom:215px;letter-spacing:-0.04px;}
#t21_349{left:137px;bottom:216px;letter-spacing:-0.16px;}
#t22_349{left:194px;bottom:215px;letter-spacing:-0.05px;}
#t23_349{left:221px;bottom:216px;letter-spacing:-0.15px;}
#t24_349{left:295px;bottom:215px;letter-spacing:-0.12px;word-spacing:3.18px;}
#t25_349{left:109px;bottom:193px;letter-spacing:-0.09px;word-spacing:0.03px;}
#t26_349{left:427px;bottom:193px;letter-spacing:-0.18px;}
#t27_349{left:460px;bottom:193px;letter-spacing:-0.12px;word-spacing:0.05px;}
#t28_349{left:137px;bottom:172px;letter-spacing:-0.11px;word-spacing:0.12px;}
#t29_349{left:109px;bottom:150px;letter-spacing:-0.1px;word-spacing:1.44px;}
#t2a_349{left:109px;bottom:129px;letter-spacing:-0.1px;word-spacing:-0.23px;}
#t2b_349{left:109px;bottom:108px;letter-spacing:-0.11px;word-spacing:0.04px;}

.s1_349{font-size:12px;font-family:NLEJCL-2bTimes-2dItalic_6pw;color:#000;}
.s2_349{font-size:15px;font-family:NLEJCK-2bTimes-2dRoman_6ps;color:#000;}
.s3_349{font-size:17px;font-family:NLEJCK-2bTimes-2dRoman_6ps;color:#000;}
.s4_349{font-size:14px;font-family:NLEKDK-2bLucidaSans-2dTypew_6pu;color:#000;}
.s5_349{font-size:17px;font-family:NLEJCL-2bTimes-2dItalic_6pw;color:#000;}
.s6_349{font-size:17px;font-family:NLEKCK-2bTimes-2dBold_6pt;color:#000;}
.s7_349{font-size:14px;font-family:NLEMHM-2bLucidaSans-2dTypew_6qf;color:#000;}
</style>
<!-- End inline CSS -->

<!-- Begin embedded font definitions -->
<style id="fonts349" type="text/css" >

@font-face {
	font-family: NLEJCK-2bTimes-2dRoman_6ps;
	src: url("fonts/NLEJCK-2bTimes-2dRoman_6ps.woff") format("woff");
}

@font-face {
	font-family: NLEJCL-2bTimes-2dItalic_6pw;
	src: url("fonts/NLEJCL-2bTimes-2dItalic_6pw.woff") format("woff");
}

@font-face {
	font-family: NLEKCK-2bTimes-2dBold_6pt;
	src: url("fonts/NLEKCK-2bTimes-2dBold_6pt.woff") format("woff");
}

@font-face {
	font-family: NLEKDK-2bLucidaSans-2dTypew_6pu;
	src: url("fonts/NLEKDK-2bLucidaSans-2dTypew_6pu.woff") format("woff");
}

@font-face {
	font-family: NLEMHM-2bLucidaSans-2dTypew_6qf;
	src: url("fonts/NLEMHM-2bLucidaSans-2dTypew_6qf.woff") format("woff");
}

</style>
<!-- End embedded font definitions -->

<!-- Begin page background -->
<div id="pg349Overlay" style="width:100%; height:100%; position:absolute; z-index:1; background-color:rgba(0,0,0,0); -webkit-user-select: none;"></div>
<div id="pg349" style="-webkit-user-select: none;"><object width="809" height="1017" data="349/349.svg" type="image/svg+xml" id="pdf349" style="width:809px; height:1017px; -moz-transform:scale(1); z-index: 0;"></object></div>
<!-- End page background -->


<!-- Begin text definitions (Positioned/styled in CSS) -->
<div class="text-container"><span id="t1_349" class="t s1_349">CHAPTER 11 </span><span id="t2_349" class="t s1_349">CONCURRENCY </span>
<span id="t3_349" class="t s2_349">328 </span>
<span id="t4_349" class="t s3_349">A few more details bear noting. The executor passed to the </span><span id="t5_349" class="t s4_349">time </span><span id="t6_349" class="t s3_349">method must </span>
<span id="t7_349" class="t s3_349">allow for the creation of at least as many threads as the given concurrency level, or </span>
<span id="t8_349" class="t s3_349">the test will never complete. This is known as a </span><span id="t9_349" class="t s5_349">thread starvation deadlock </span>
<span id="ta_349" class="t s3_349">[Goetz06, 8.1.1]. If a worker thread catches an </span><span id="tb_349" class="t s4_349">InterruptedException</span><span id="tc_349" class="t s3_349">, it </span>
<span id="td_349" class="t s3_349">reasserts the interrupt using the idiom </span><span id="te_349" class="t s4_349">Thread.currentThread().interrupt() </span>
<span id="tf_349" class="t s3_349">and returns from its </span><span id="tg_349" class="t s4_349">run </span><span id="th_349" class="t s3_349">method. This allows the executor to deal with the interrupt </span>
<span id="ti_349" class="t s3_349">as it sees fit. Note that </span><span id="tj_349" class="t s4_349">System.nanoTime </span><span id="tk_349" class="t s3_349">is used to time the activity. </span><span id="tl_349" class="t s6_349">For interval </span>
<span id="tm_349" class="t s6_349">timing, always use </span><span id="tn_349" class="t s7_349">System.nanoTime </span><span id="to_349" class="t s6_349">rather than </span><span id="tp_349" class="t s7_349">System.currentTimeMillis</span><span id="tq_349" class="t s6_349">. </span>
<span id="tr_349" class="t s4_349">System.nanoTime </span><span id="ts_349" class="t s3_349">is both more accurate and more precise and is unaffected by </span>
<span id="tt_349" class="t s3_349">adjustments to the system’s real-time clock. Finally, note that the code in this </span>
<span id="tu_349" class="t s3_349">example won’t yield accurate timings unless </span><span id="tv_349" class="t s4_349">action </span><span id="tw_349" class="t s3_349">does a fair amount of work, </span>
<span id="tx_349" class="t s3_349">say a second or more. Accurate microbenchmarking is notoriously hard and is best </span>
<span id="ty_349" class="t s3_349">done with the aid of a specialized framework such as jmh [JMH]. </span>
<span id="tz_349" class="t s3_349">This item only scratches the surface of what you can do with the concurrency </span>
<span id="t10_349" class="t s3_349">utilities. For example, the three countdown latches in the previous example could </span>
<span id="t11_349" class="t s3_349">be replaced by a single </span><span id="t12_349" class="t s4_349">CyclicBarrier </span><span id="t13_349" class="t s3_349">or </span><span id="t14_349" class="t s4_349">Phaser </span><span id="t15_349" class="t s3_349">instance. The resulting code </span>
<span id="t16_349" class="t s3_349">would be a bit more concise but perhaps more difficult to understand. </span>
<span id="t17_349" class="t s3_349">While you should always use the concurrency utilities in preference to </span><span id="t18_349" class="t s4_349">wait </span>
<span id="t19_349" class="t s3_349">and </span><span id="t1a_349" class="t s4_349">notify </span><span id="t1b_349" class="t s3_349">, you might have to maintain legacy code that uses </span><span id="t1c_349" class="t s4_349">wait </span><span id="t1d_349" class="t s3_349">and </span><span id="t1e_349" class="t s4_349">notify </span><span id="t1f_349" class="t s3_349">. </span>
<span id="t1g_349" class="t s3_349">The </span><span id="t1h_349" class="t s4_349">wait </span><span id="t1i_349" class="t s3_349">method is used to make a thread wait for some condition. It must be </span>
<span id="t1j_349" class="t s3_349">invoked inside a synchronized region that locks the object on which it is invoked. </span>
<span id="t1k_349" class="t s3_349">Here is the standard idiom for using the </span><span id="t1l_349" class="t s4_349">wait </span><span id="t1m_349" class="t s3_349">method: </span>
<span id="t1n_349" class="t s7_349">// The standard idiom for using the wait method </span>
<span id="t1o_349" class="t s4_349">synchronized (obj) { </span>
<span id="t1p_349" class="t s4_349">while (&lt;condition does not hold&gt;) </span>
<span id="t1q_349" class="t s4_349">obj.wait(); // (Releases lock, and reacquires on wakeup) </span>
<span id="t1r_349" class="t s4_349">... // Perform action appropriate to condition </span>
<span id="t1s_349" class="t s4_349">} </span>
<span id="t1t_349" class="t s6_349">Always use the wait loop idiom to invoke the </span><span id="t1u_349" class="t s7_349">wait </span><span id="t1v_349" class="t s6_349">method; never invoke it </span>
<span id="t1w_349" class="t s6_349">outside of a loop. </span><span id="t1x_349" class="t s3_349">The loop serves to test the condition before and after waiting. </span>
<span id="t1y_349" class="t s3_349">Testing the condition before waiting and skipping the wait if the condition </span>
<span id="t1z_349" class="t s3_349">already holds are necessary to ensure liveness. If the condition already holds and </span>
<span id="t20_349" class="t s3_349">the </span><span id="t21_349" class="t s4_349">notify </span><span id="t22_349" class="t s3_349">(or </span><span id="t23_349" class="t s4_349">notifyAll</span><span id="t24_349" class="t s3_349">) method has already been invoked before a thread </span>
<span id="t25_349" class="t s3_349">waits, there is no guarantee that the thread will </span><span id="t26_349" class="t s5_349">ever </span><span id="t27_349" class="t s3_349">wake from the wait. </span>
<span id="t28_349" class="t s3_349">Testing the condition after waiting and waiting again if the condition does not </span>
<span id="t29_349" class="t s3_349">hold are necessary to ensure safety. If the thread proceeds with the action when </span>
<span id="t2a_349" class="t s3_349">the condition does not hold, it can destroy the invariant guarded by the lock. There </span>
<span id="t2b_349" class="t s3_349">are several reasons a thread might wake up when the condition does not hold: </span></div>
<!-- End text definitions -->


</div>
</body>
</html>
