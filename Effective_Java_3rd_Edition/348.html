<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=Edge" />
<meta charset="utf-8" />
</head>

<body style="margin: 0;">

<div id="p348" style="overflow: hidden; position: relative; background-color: white; width: 809px; height: 1017px;">

<!-- Begin shared CSS values -->
<style class="shared-css" type="text/css" >
.t {
	transform-origin: bottom left;
	z-index: 2;
	position: absolute;
	white-space: pre;
	overflow: visible;
	line-height: 1.5;
}
.text-container {
	white-space: pre;
}
@supports (-webkit-touch-callout: none) {
	.text-container {
		white-space: normal;
	}
}
</style>
<!-- End shared CSS values -->


<!-- Begin inline CSS -->
<style type="text/css" >

#t1_348{left:333px;bottom:955px;letter-spacing:0.12px;word-spacing:-0.03px;}
#t2_348{left:728px;bottom:953px;letter-spacing:0.15px;}
#t3_348{left:150px;bottom:900px;letter-spacing:-0.1px;word-spacing:2.86px;}
#t4_348{left:150px;bottom:878px;letter-spacing:-0.1px;word-spacing:0.83px;}
#t5_348{left:150px;bottom:857px;letter-spacing:-0.12px;word-spacing:0.6px;}
#t6_348{left:150px;bottom:836px;letter-spacing:-0.09px;word-spacing:0.55px;}
#t7_348{left:150px;bottom:814px;letter-spacing:-0.08px;word-spacing:-0.33px;}
#t8_348{left:540px;bottom:816px;letter-spacing:-0.15px;}
#t9_348{left:577px;bottom:814px;letter-spacing:-0.07px;}
#ta_348{left:605px;bottom:816px;letter-spacing:-0.16px;}
#tb_348{left:659px;bottom:814px;letter-spacing:-0.16px;}
#tc_348{left:150px;bottom:793px;letter-spacing:-0.1px;word-spacing:5.34px;}
#td_348{left:150px;bottom:773px;letter-spacing:-0.16px;}
#te_348{left:266px;bottom:771px;}
#tf_348{left:178px;bottom:740px;letter-spacing:-0.16px;}
#tg_348{left:178px;bottom:723px;letter-spacing:-0.25px;word-spacing:0.01px;}
#th_348{left:276px;bottom:706px;letter-spacing:-0.24px;}
#ti_348{left:211px;bottom:690px;letter-spacing:-0.24px;}
#tj_348{left:211px;bottom:673px;letter-spacing:-0.25px;}
#tk_348{left:211px;bottom:656px;letter-spacing:-0.25px;word-spacing:2.04px;}
#tl_348{left:211px;bottom:623px;letter-spacing:-0.25px;word-spacing:0.01px;}
#tm_348{left:243px;bottom:606px;letter-spacing:-0.24px;word-spacing:-0.03px;}
#tn_348{left:276px;bottom:590px;letter-spacing:-0.24px;word-spacing:-0.01px;}
#to_348{left:276px;bottom:573px;letter-spacing:-0.24px;word-spacing:-0.03px;}
#tp_348{left:309px;bottom:556px;letter-spacing:-0.25px;word-spacing:-0.01px;}
#tq_348{left:309px;bottom:540px;letter-spacing:-0.25px;}
#tr_348{left:276px;bottom:523px;letter-spacing:-0.25px;}
#ts_348{left:309px;bottom:507px;letter-spacing:-0.24px;}
#tt_348{left:276px;bottom:490px;letter-spacing:-0.25px;word-spacing:0.02px;}
#tu_348{left:309px;bottom:473px;letter-spacing:-0.23px;}
#tv_348{left:464px;bottom:473px;letter-spacing:-0.25px;word-spacing:0.02px;}
#tw_348{left:276px;bottom:457px;}
#tx_348{left:243px;bottom:440px;letter-spacing:-0.27px;}
#ty_348{left:211px;bottom:423px;}
#tz_348{left:211px;bottom:390px;letter-spacing:-0.23px;}
#t10_348{left:366px;bottom:390px;letter-spacing:-0.24px;}
#t11_348{left:211px;bottom:373px;letter-spacing:-0.25px;word-spacing:0.01px;}
#t12_348{left:211px;bottom:357px;letter-spacing:-0.25px;word-spacing:0.05px;}
#t13_348{left:211px;bottom:340px;letter-spacing:-0.23px;}
#t14_348{left:366px;bottom:340px;letter-spacing:-0.24px;word-spacing:-0.01px;}
#t15_348{left:211px;bottom:323px;letter-spacing:-0.25px;word-spacing:0.01px;}
#t16_348{left:178px;bottom:307px;}
#t17_348{left:178px;bottom:273px;letter-spacing:-0.1px;word-spacing:1.08px;}
#t18_348{left:604px;bottom:274px;letter-spacing:-0.15px;}
#t19_348{left:644px;bottom:273px;letter-spacing:-0.06px;word-spacing:1px;}
#t1a_348{left:150px;bottom:251px;letter-spacing:-0.13px;word-spacing:0.46px;}
#t1b_348{left:150px;bottom:230px;letter-spacing:-0.1px;word-spacing:3.59px;}
#t1c_348{left:443px;bottom:231px;letter-spacing:-0.15px;}
#t1d_348{left:484px;bottom:230px;letter-spacing:-0.11px;word-spacing:3.59px;}
#t1e_348{left:150px;bottom:208px;letter-spacing:-0.28px;}
#t1f_348{left:208px;bottom:210px;letter-spacing:-0.16px;}
#t1g_348{left:332px;bottom:208px;letter-spacing:-0.12px;word-spacing:2.74px;}
#t1h_348{left:150px;bottom:188px;letter-spacing:-0.16px;}
#t1i_348{left:274px;bottom:187px;letter-spacing:-0.1px;word-spacing:0.88px;}
#t1j_348{left:150px;bottom:166px;letter-spacing:-0.09px;word-spacing:1.03px;}
#t1k_348{left:365px;bottom:167px;letter-spacing:-0.15px;}
#t1l_348{left:398px;bottom:166px;letter-spacing:-0.1px;word-spacing:1.03px;}
#t1m_348{left:150px;bottom:144px;letter-spacing:-0.09px;word-spacing:0.65px;}
#t1n_348{left:343px;bottom:146px;letter-spacing:-0.16px;}
#t1o_348{left:459px;bottom:144px;letter-spacing:-0.08px;word-spacing:0.58px;}
#t1p_348{left:150px;bottom:123px;letter-spacing:-0.11px;word-spacing:0.02px;}

.s1_348{font-size:12px;font-family:NLEJCL-2bTimes-2dItalic_6pw;color:#000;}
.s2_348{font-size:15px;font-family:NLEJCK-2bTimes-2dRoman_6ps;color:#000;}
.s3_348{font-size:17px;font-family:NLEJCK-2bTimes-2dRoman_6ps;color:#000;}
.s4_348{font-size:14px;font-family:NLEKDK-2bLucidaSans-2dTypew_6pu;color:#000;}
.s5_348{font-size:14px;font-family:NLEMHM-2bLucidaSans-2dTypew_6qf;color:#000;}
</style>
<!-- End inline CSS -->

<!-- Begin embedded font definitions -->
<style id="fonts348" type="text/css" >

@font-face {
	font-family: NLEJCK-2bTimes-2dRoman_6ps;
	src: url("fonts/NLEJCK-2bTimes-2dRoman_6ps.woff") format("woff");
}

@font-face {
	font-family: NLEJCL-2bTimes-2dItalic_6pw;
	src: url("fonts/NLEJCL-2bTimes-2dItalic_6pw.woff") format("woff");
}

@font-face {
	font-family: NLEKDK-2bLucidaSans-2dTypew_6pu;
	src: url("fonts/NLEKDK-2bLucidaSans-2dTypew_6pu.woff") format("woff");
}

@font-face {
	font-family: NLEMHM-2bLucidaSans-2dTypew_6qf;
	src: url("fonts/NLEMHM-2bLucidaSans-2dTypew_6qf.woff") format("woff");
}

</style>
<!-- End embedded font definitions -->

<!-- Begin page background -->
<div id="pg348Overlay" style="width:100%; height:100%; position:absolute; z-index:1; background-color:rgba(0,0,0,0); -webkit-user-select: none;"></div>
<div id="pg348" style="-webkit-user-select: none;"><object width="809" height="1017" data="348/348.svg" type="image/svg+xml" id="pdf348" style="width:809px; height:1017px; -moz-transform:scale(1); z-index: 0;"></object></div>
<!-- End page background -->


<!-- Begin text definitions (Positioned/styled in CSS) -->
<div class="text-container"><span id="t1_348" class="t s1_348">ITEM 81: PREFER CONCURRENCY UTILITIES TO WAIT AND NOTIFY </span><span id="t2_348" class="t s2_348">327 </span>
<span id="t3_348" class="t s3_348">the worker threads ready themselves to run the action before the timer thread </span>
<span id="t4_348" class="t s3_348">starts the clock. When the last worker thread is ready to run the action, the timer </span>
<span id="t5_348" class="t s3_348">thread “fires the starting gun,” allowing the worker threads to perform the action. </span>
<span id="t6_348" class="t s3_348">As soon as the last worker thread finishes performing the action, the timer thread </span>
<span id="t7_348" class="t s3_348">stops the clock. Implementing this logic directly on top of </span><span id="t8_348" class="t s4_348">wait </span><span id="t9_348" class="t s3_348">and </span><span id="ta_348" class="t s4_348">notify </span><span id="tb_348" class="t s3_348">would </span>
<span id="tc_348" class="t s3_348">be messy to say the least, but it is surprisingly straightforward on top of </span>
<span id="td_348" class="t s4_348">CountDownLatch</span><span id="te_348" class="t s3_348">: </span>
<span id="tf_348" class="t s5_348">// Simple framework for timing concurrent execution </span>
<span id="tg_348" class="t s4_348">public static long time(Executor executor, int concurrency, </span>
<span id="th_348" class="t s4_348">Runnable action) throws InterruptedException { </span>
<span id="ti_348" class="t s4_348">CountDownLatch ready = new CountDownLatch(concurrency); </span>
<span id="tj_348" class="t s4_348">CountDownLatch start = new CountDownLatch(1); </span>
<span id="tk_348" class="t s4_348">CountDownLatch done = new CountDownLatch(concurrency); </span>
<span id="tl_348" class="t s4_348">for (int i = 0; i &lt; concurrency; i++) { </span>
<span id="tm_348" class="t s4_348">executor.execute(() -&gt; { </span>
<span id="tn_348" class="t s4_348">ready.countDown(); // Tell timer we're ready </span>
<span id="to_348" class="t s4_348">try { </span>
<span id="tp_348" class="t s4_348">start.await(); // Wait till peers are ready </span>
<span id="tq_348" class="t s4_348">action.run(); </span>
<span id="tr_348" class="t s4_348">} catch (InterruptedException e) { </span>
<span id="ts_348" class="t s4_348">Thread.currentThread().interrupt(); </span>
<span id="tt_348" class="t s4_348">} finally { </span>
<span id="tu_348" class="t s4_348">done.countDown(); </span><span id="tv_348" class="t s4_348">// Tell timer we're done </span>
<span id="tw_348" class="t s4_348">} </span>
<span id="tx_348" class="t s4_348">}); </span>
<span id="ty_348" class="t s4_348">} </span>
<span id="tz_348" class="t s4_348">ready.await(); </span><span id="t10_348" class="t s4_348">// Wait for all workers to be ready </span>
<span id="t11_348" class="t s4_348">long startNanos = System.nanoTime(); </span>
<span id="t12_348" class="t s4_348">start.countDown(); // And they're off! </span>
<span id="t13_348" class="t s4_348">done.await(); </span><span id="t14_348" class="t s4_348">// Wait for all workers to finish </span>
<span id="t15_348" class="t s4_348">return System.nanoTime() - startNanos; </span>
<span id="t16_348" class="t s4_348">} </span>
<span id="t17_348" class="t s3_348">Note that the method uses three countdown latches. The first, </span><span id="t18_348" class="t s4_348">ready </span><span id="t19_348" class="t s3_348">, is used </span>
<span id="t1a_348" class="t s3_348">by worker threads to tell the timer thread when they’re ready. The worker threads </span>
<span id="t1b_348" class="t s3_348">then wait on the second latch, which is </span><span id="t1c_348" class="t s4_348">start</span><span id="t1d_348" class="t s3_348">. When the last worker thread </span>
<span id="t1e_348" class="t s3_348">invokes </span><span id="t1f_348" class="t s4_348">ready.countDown</span><span id="t1g_348" class="t s3_348">, the timer thread records the start time and invokes </span>
<span id="t1h_348" class="t s4_348">start.countDown</span><span id="t1i_348" class="t s3_348">, allowing all of the worker threads to proceed. Then the timer </span>
<span id="t1j_348" class="t s3_348">thread waits on the third latch, </span><span id="t1k_348" class="t s4_348">done</span><span id="t1l_348" class="t s3_348">, until the last of the worker threads finishes </span>
<span id="t1m_348" class="t s3_348">running the action and calls </span><span id="t1n_348" class="t s4_348">done.countDown</span><span id="t1o_348" class="t s3_348">. As soon as this happens, the timer </span>
<span id="t1p_348" class="t s3_348">thread awakens and records the end time. </span></div>
<!-- End text definitions -->


</div>
</body>
</html>
