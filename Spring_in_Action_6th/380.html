<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=Edge" />
<meta charset="utf-8" />
</head>

<body style="margin: 0;">

<div id="p380" style="overflow: hidden; position: relative; background-color: white; width: 811px; height: 1017px;">

<!-- Begin shared CSS values -->
<style class="shared-css" type="text/css" >
.t {
	transform-origin: bottom left;
	z-index: 2;
	position: absolute;
	white-space: pre;
	overflow: visible;
	line-height: 1.5;
}
.text-container {
	white-space: pre;
}
@supports (-webkit-touch-callout: none) {
	.text-container {
		white-space: normal;
	}
}
</style>
<!-- End shared CSS values -->


<!-- Begin inline CSS -->
<style type="text/css" >

#t1_380{left:703px;bottom:960px;letter-spacing:-0.13px;}
#t2_380{left:261px;bottom:961px;letter-spacing:-0.11px;word-spacing:0.01px;}
#t3_380{left:180px;bottom:917px;letter-spacing:0.11px;word-spacing:1.6px;}
#t4_380{left:156px;bottom:898px;letter-spacing:0.21px;}
#t5_380{left:365px;bottom:898px;letter-spacing:0.12px;word-spacing:1.38px;}
#t6_380{left:446px;bottom:898px;letter-spacing:0.22px;}
#t7_380{left:522px;bottom:898px;letter-spacing:0.13px;word-spacing:1.43px;}
#t8_380{left:156px;bottom:878px;letter-spacing:0.1px;word-spacing:0.33px;}
#t9_380{left:251px;bottom:878px;letter-spacing:0.22px;}
#ta_380{left:286px;bottom:878px;letter-spacing:0.1px;word-spacing:0.33px;}
#tb_380{left:407px;bottom:878px;letter-spacing:0.21px;}
#tc_380{left:482px;bottom:878px;letter-spacing:0.1px;word-spacing:0.33px;}
#td_380{left:584px;bottom:878px;letter-spacing:0.23px;}
#te_380{left:635px;bottom:878px;letter-spacing:0.14px;word-spacing:0.32px;}
#tf_380{left:156px;bottom:858px;letter-spacing:0.22px;}
#tg_380{left:352px;bottom:858px;letter-spacing:0.13px;word-spacing:4.36px;}
#th_380{left:484px;bottom:858px;letter-spacing:0.22px;}
#ti_380{left:609px;bottom:858px;letter-spacing:0.14px;word-spacing:4.36px;}
#tj_380{left:156px;bottom:838px;letter-spacing:0.12px;word-spacing:0.69px;}
#tk_380{left:286px;bottom:838px;letter-spacing:0.21px;}
#tl_380{left:380px;bottom:838px;letter-spacing:0.1px;word-spacing:0.75px;}
#tm_380{left:510px;bottom:838px;letter-spacing:0.22px;}
#tn_380{left:585px;bottom:838px;letter-spacing:0.13px;word-spacing:0.68px;}
#to_380{left:693px;bottom:838px;letter-spacing:0.22px;}
#tp_380{left:156px;bottom:818px;letter-spacing:0.12px;word-spacing:-0.02px;}
#tq_380{left:568px;bottom:819px;letter-spacing:0.22px;}
#tr_380{left:603px;bottom:818px;letter-spacing:0.12px;}
#ts_380{left:179px;bottom:798px;letter-spacing:0.26px;word-spacing:0.41px;}
#tt_380{left:358px;bottom:799px;letter-spacing:0.38px;}
#tu_380{left:442px;bottom:798px;letter-spacing:0.27px;word-spacing:0.36px;}
#tv_380{left:645px;bottom:799px;letter-spacing:0.38px;}
#tw_380{left:156px;bottom:779px;letter-spacing:0.37px;}
#tx_380{left:204px;bottom:778px;letter-spacing:0.26px;word-spacing:2.1px;}
#ty_380{left:349px;bottom:779px;letter-spacing:0.39px;}
#tz_380{left:397px;bottom:778px;letter-spacing:0.22px;word-spacing:2.13px;}
#t10_380{left:421px;bottom:779px;letter-spacing:0.39px;}
#t11_380{left:523px;bottom:778px;letter-spacing:0.28px;word-spacing:2.1px;}
#t12_380{left:156px;bottom:759px;letter-spacing:0.38px;}
#t13_380{left:232px;bottom:759px;letter-spacing:0.26px;word-spacing:-0.09px;}
#t14_380{left:340px;bottom:759px;letter-spacing:0.39px;}
#t15_380{left:376px;bottom:759px;letter-spacing:0.27px;word-spacing:-0.13px;}
#t16_380{left:156px;bottom:739px;letter-spacing:0.27px;}
#t17_380{left:180px;bottom:719px;letter-spacing:0.12px;word-spacing:1.61px;}
#t18_380{left:237px;bottom:719px;letter-spacing:0.21px;}
#t19_380{left:337px;bottom:719px;letter-spacing:0.1px;word-spacing:1.71px;}
#t1a_380{left:470px;bottom:719px;letter-spacing:0.22px;}
#t1b_380{left:601px;bottom:719px;letter-spacing:0.11px;word-spacing:1.71px;}
#t1c_380{left:156px;bottom:699px;letter-spacing:0.11px;word-spacing:0.02px;}
#t1d_380{left:335px;bottom:699px;letter-spacing:0.22px;}
#t1e_380{left:371px;bottom:699px;letter-spacing:0.1px;word-spacing:0.01px;}
#t1f_380{left:456px;bottom:699px;letter-spacing:0.19px;}
#t1g_380{left:491px;bottom:699px;letter-spacing:0.11px;word-spacing:-0.03px;}
#t1h_380{left:180px;bottom:679px;letter-spacing:-0.1px;word-spacing:2.07px;}
#t1i_380{left:156px;bottom:659px;letter-spacing:-0.11px;word-spacing:0.46px;}
#t1j_380{left:233px;bottom:660px;letter-spacing:-0.02px;}
#t1k_380{left:268px;bottom:659px;letter-spacing:-0.12px;word-spacing:0.51px;}
#t1l_380{left:499px;bottom:660px;letter-spacing:-0.02px;}
#t1m_380{left:580px;bottom:659px;letter-spacing:-0.1px;word-spacing:0.49px;}
#t1n_380{left:156px;bottom:639px;letter-spacing:-0.13px;word-spacing:1.11px;}
#t1o_380{left:247px;bottom:640px;letter-spacing:-0.03px;}
#t1p_380{left:328px;bottom:639px;letter-spacing:-0.12px;word-spacing:1.13px;}
#t1q_380{left:156px;bottom:620px;letter-spacing:-0.02px;}
#t1r_380{left:191px;bottom:620px;letter-spacing:-0.11px;word-spacing:0.38px;}
#t1s_380{left:354px;bottom:620px;letter-spacing:-0.02px;}
#t1t_380{left:388px;bottom:620px;letter-spacing:-0.13px;word-spacing:0.38px;}
#t1u_380{left:493px;bottom:620px;letter-spacing:-0.02px;}
#t1v_380{left:565px;bottom:620px;letter-spacing:-0.12px;word-spacing:0.37px;}
#t1w_380{left:648px;bottom:620px;letter-spacing:-0.03px;}
#t1x_380{left:156px;bottom:600px;letter-spacing:-0.12px;word-spacing:-0.03px;}
#t1y_380{left:465px;bottom:600px;letter-spacing:-0.02px;}
#t1z_380{left:617px;bottom:600px;}
#t20_380{left:178px;bottom:580px;letter-spacing:0.12px;word-spacing:-0.11px;}
#t21_380{left:156px;bottom:560px;letter-spacing:0.11px;word-spacing:0.97px;}
#t22_380{left:156px;bottom:540px;letter-spacing:0.12px;word-spacing:0.51px;}
#t23_380{left:156px;bottom:520px;letter-spacing:0.11px;word-spacing:-0.02px;}
#t24_380{left:101px;bottom:478px;letter-spacing:-0.52px;}
#t25_380{left:156px;bottom:478px;letter-spacing:0.05px;word-spacing:-0.02px;}
#t26_380{left:156px;bottom:454px;letter-spacing:0.13px;word-spacing:1.36px;}
#t27_380{left:156px;bottom:434px;letter-spacing:-0.02px;word-spacing:-0.25px;}
#t28_380{left:156px;bottom:414px;letter-spacing:0.12px;word-spacing:-0.03px;}
#t29_380{left:181px;bottom:394px;letter-spacing:0.27px;word-spacing:2.56px;}
#t2a_380{left:156px;bottom:374px;letter-spacing:0.14px;word-spacing:0.46px;}
#t2b_380{left:156px;bottom:354px;letter-spacing:0.12px;word-spacing:-0.18px;}
#t2c_380{left:156px;bottom:335px;letter-spacing:0.12px;word-spacing:-0.04px;}
#t2d_380{left:156px;bottom:300px;letter-spacing:0.13px;}
#t2e_380{left:185px;bottom:285px;letter-spacing:0.14px;}
#t2f_380{left:185px;bottom:269px;letter-spacing:0.14px;}
#t2g_380{left:156px;bottom:254px;letter-spacing:0.13px;}
#t2h_380{left:156px;bottom:212px;letter-spacing:0.12px;word-spacing:1.95px;}
#t2i_380{left:156px;bottom:192px;letter-spacing:0.11px;word-spacing:2.43px;}
#t2j_380{left:156px;bottom:173px;letter-spacing:0.12px;word-spacing:-0.27px;}
#t2k_380{left:156px;bottom:153px;letter-spacing:0.13px;word-spacing:-0.03px;}
#t2l_380{left:178px;bottom:133px;letter-spacing:0.12px;word-spacing:-0.4px;}
#t2m_380{left:156px;bottom:113px;letter-spacing:0.13px;word-spacing:-0.01px;}

.s1_380{font-size:14px;font-family:NewBaskerville-Bold_h-a;color:#000;}
.s2_380{font-size:14px;font-family:NewBaskerville-BoldItalic_h-c;color:#656565;}
.s3_380{font-size:15px;font-family:NewBaskerville-Roman_ib3;color:#252525;}
.s4_380{font-size:14px;font-family:Courier_h-e;color:#252525;}
.s5_380{font-size:19px;font-family:FranklinGothic-DemiItal_ib5;color:#476B85;}
.s6_380{font-size:12px;font-family:Courier_h-e;color:#252525;}
.t.v0_380{transform:scaleX(0.907);}
</style>
<!-- End inline CSS -->

<!-- Begin embedded font definitions -->
<style id="fonts380" type="text/css" >

@font-face {
	font-family: Courier_h-e;
	src: url("fonts/Courier_h-e.woff") format("woff");
}

@font-face {
	font-family: FranklinGothic-DemiItal_ib5;
	src: url("fonts/FranklinGothic-DemiItal_ib5.woff") format("woff");
}

@font-face {
	font-family: NewBaskerville-BoldItalic_h-c;
	src: url("fonts/NewBaskerville-BoldItalic_h-c.woff") format("woff");
}

@font-face {
	font-family: NewBaskerville-Bold_h-a;
	src: url("fonts/NewBaskerville-Bold_h-a.woff") format("woff");
}

@font-face {
	font-family: NewBaskerville-Roman_ib3;
	src: url("fonts/NewBaskerville-Roman_ib3.woff") format("woff");
}

</style>
<!-- End embedded font definitions -->

<!-- Begin page background -->
<div id="pg380Overlay" style="width:100%; height:100%; position:absolute; z-index:1; background-color:rgba(0,0,0,0); -webkit-user-select: none;"></div>
<div id="pg380" style="-webkit-user-select: none;"><object width="811" height="1017" data="380/380.svg" type="image/svg+xml" id="pdf380" style="width:811px; height:1017px; -moz-transform:scale(1); z-index: 0;"></object></div>
<!-- End page background -->


<!-- Begin text definitions (Positioned/styled in CSS) -->
<div class="text-container"><span id="t1_380" class="t s1_380">353 </span><span id="t2_380" class="t s2_380">Persisting document data reactively with MongoDB </span>
<span id="t3_380" class="t s3_380">Now we’re finally ready to test our aggregation service. The first several lines of </span>
<span id="t4_380" class="t v0_380 s4_380">shouldSaveAndFetchOrders() </span><span id="t5_380" class="t s3_380">builds up a </span><span id="t6_380" class="t v0_380 s4_380">TacoOrder </span><span id="t7_380" class="t s3_380">object and populates it with a </span>
<span id="t8_380" class="t s3_380">couple of test </span><span id="t9_380" class="t v0_380 s4_380">Taco </span><span id="ta_380" class="t s3_380">objects. Then the </span><span id="tb_380" class="t v0_380 s4_380">TacoOrder </span><span id="tc_380" class="t s3_380">is saved via the </span><span id="td_380" class="t v0_380 s4_380">save() </span><span id="te_380" class="t s3_380">method from </span>
<span id="tf_380" class="t v0_380 s4_380">TacoOrderAggregateService</span><span id="tg_380" class="t s3_380">, which returns a </span><span id="th_380" class="t v0_380 s4_380">Mono&lt;TacoOrder&gt; </span><span id="ti_380" class="t s3_380">representing the </span>
<span id="tj_380" class="t s3_380">saved order. Using </span><span id="tk_380" class="t v0_380 s4_380">StepVerifier</span><span id="tl_380" class="t s3_380">, we assert that the </span><span id="tm_380" class="t v0_380 s4_380">TacoOrder </span><span id="tn_380" class="t s3_380">in the returned </span><span id="to_380" class="t v0_380 s4_380">Mono </span>
<span id="tp_380" class="t s3_380">matches our expectations, including that it contains the child </span><span id="tq_380" class="t v0_380 s4_380">Taco </span><span id="tr_380" class="t s3_380">objects. </span>
<span id="ts_380" class="t s3_380">Next, we call the service’s </span><span id="tt_380" class="t v0_380 s4_380">findById() </span><span id="tu_380" class="t s3_380">method, which also returns a </span><span id="tv_380" class="t v0_380 s4_380">Mono&lt;Taco- </span>
<span id="tw_380" class="t v0_380 s4_380">Order&gt;</span><span id="tx_380" class="t s3_380">. As with the call to </span><span id="ty_380" class="t v0_380 s4_380">save()</span><span id="tz_380" class="t s3_380">, a </span><span id="t10_380" class="t v0_380 s4_380">StepVerifier </span><span id="t11_380" class="t s3_380">is used to step through each </span>
<span id="t12_380" class="t v0_380 s4_380">TacoOrder </span><span id="t13_380" class="t s3_380">in the returned </span><span id="t14_380" class="t v0_380 s4_380">Mono </span><span id="t15_380" class="t s3_380">(there should be only one) and asserts that it meets </span>
<span id="t16_380" class="t s3_380">our expectations. </span>
<span id="t17_380" class="t s3_380">In both </span><span id="t18_380" class="t v0_380 s4_380">StepVerifier </span><span id="t19_380" class="t s3_380">situations, a call to </span><span id="t1a_380" class="t v0_380 s4_380">verifyComplete() </span><span id="t1b_380" class="t s3_380">ensures that there </span>
<span id="t1c_380" class="t s3_380">are no more objects in the </span><span id="t1d_380" class="t v0_380 s4_380">Mono </span><span id="t1e_380" class="t s3_380">and that the </span><span id="t1f_380" class="t v0_380 s4_380">Mono </span><span id="t1g_380" class="t s3_380">is complete. </span>
<span id="t1h_380" class="t s3_380">It’s worth noting that although we could apply a similar aggregation operation to </span>
<span id="t1i_380" class="t s3_380">ensure that </span><span id="t1j_380" class="t v0_380 s4_380">Taco </span><span id="t1k_380" class="t s3_380">objects always contain fully defined </span><span id="t1l_380" class="t v0_380 s4_380">Ingredient </span><span id="t1m_380" class="t s3_380">objects, we choose not </span>
<span id="t1n_380" class="t s3_380">to, given that </span><span id="t1o_380" class="t v0_380 s4_380">Ingredient </span><span id="t1p_380" class="t s3_380">is its own aggregate root, likely being referenced by multiple </span>
<span id="t1q_380" class="t v0_380 s4_380">Taco </span><span id="t1r_380" class="t s3_380">objects. Therefore, every </span><span id="t1s_380" class="t v0_380 s4_380">Taco </span><span id="t1t_380" class="t s3_380">will carry only a </span><span id="t1u_380" class="t v0_380 s4_380">Set&lt;Long&gt; </span><span id="t1v_380" class="t s3_380">to reference </span><span id="t1w_380" class="t v0_380 s4_380">Ingredient </span>
<span id="t1x_380" class="t s3_380">IDs, which can then be looked up separately via </span><span id="t1y_380" class="t v0_380 s4_380">IngredientRepository</span><span id="t1z_380" class="t s3_380">. </span>
<span id="t20_380" class="t s3_380">Although it may require a bit more work to aggregate entities, Spring Data R2DBC </span>
<span id="t21_380" class="t s3_380">provides a way of working with relational data in a reactive way. But it’s not the only </span>
<span id="t22_380" class="t s3_380">reactive persistence option provided by Spring. Let’s have a look at how to work with </span>
<span id="t23_380" class="t s3_380">MongoDB using reactive Spring Data repositories. </span>
<span id="t24_380" class="t s5_380">13.2 </span><span id="t25_380" class="t s5_380">Persisting document data reactively with MongoDB </span>
<span id="t26_380" class="t s3_380">In chapter 4, we used Spring Data MongoDB to define document-based persistence </span>
<span id="t27_380" class="t s3_380">against a MongoDB document database. In this section, we’re going to revisit MongoDB </span>
<span id="t28_380" class="t s3_380">persistence using Spring Data’s reactive support for MongoDB. </span>
<span id="t29_380" class="t s3_380">To get started, you’ll need to create a project with the Spring Data Reactive </span>
<span id="t2a_380" class="t s3_380">MongoDB starter. That is, in fact, the name of the check box to select when creating </span>
<span id="t2b_380" class="t s3_380">the project with the Initalizr. Or you can add it manually to your Maven build with the </span>
<span id="t2c_380" class="t s3_380">following dependency: </span>
<span id="t2d_380" class="t s6_380">&lt;dependency&gt; </span>
<span id="t2e_380" class="t s6_380">&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; </span>
<span id="t2f_380" class="t s6_380">&lt;artifactId&gt;spring-boot-starter-data-mongodb-reactive&lt;/artifactId&gt; </span>
<span id="t2g_380" class="t s6_380">&lt;/dependency&gt; </span>
<span id="t2h_380" class="t s3_380">In chapter 4, we also leaned on the Flapdoodle embedded MongoDB database for </span>
<span id="t2i_380" class="t s3_380">testing. Unfortunately, Flapdoodle doesn’t behave quite as well when fronted with </span>
<span id="t2j_380" class="t s3_380">reactive repositories. When it comes to running the tests, you’ll need to have an actual </span>
<span id="t2k_380" class="t s3_380">Mongo database running and listening on port 27017. </span>
<span id="t2l_380" class="t s3_380">Now we’re ready to start writing code for reactive MongoDB persistence. We’ll start </span>
<span id="t2m_380" class="t s3_380">with the document types that make up our domain. </span></div>
<!-- End text definitions -->


</div>
</body>
</html>
